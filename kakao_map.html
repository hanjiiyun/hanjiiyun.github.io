<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0; padding:0; height:100%;
    }
    #map { width:100%; height:100vh; }

    /* ====================================
       ⭐ 사용자 방향 아이콘 전체 스타일
       ==================================== */

    /* 바깥 큰 번짐(halo) */
    .user-dir-marker-outer {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-sizing: border-box;
      transform-origin: center center;
    }

    /* 안쪽 파란 동그라미 */
    .user-dir-marker-core {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #FFF;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
      position: relative;
      z-index: 2;
    }

    /* 삼각형을 바깥으로 빼는 래퍼 */
    .user-dir-marker-arrow-wrap {
      position: absolute;
      top: calc(50% + 18px);   /* ⭐ -18px 효과 = 아래로 18px 이동 */
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
    }

    /* 방향 삼각형 */
    .user-dir-marker-arrow {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 10px solid white;  /* 위쪽이 뾰족 → 회전으로 방향 표시 */
    }
  </style>

  <!-- Kakao map + geometry -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    let map;

    let routeCoords = [];
    let routeLineDone = null;
    let routeLineRemain = null;
    let startMarker = null;
    let endMarker = null;

    let userDirectionOverlay = null;
    let isNavigationMode = false;

    /* ================================
       ⭐ 지도 초기화
       ================================ */
    (function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      };
      map = new kakao.maps.Map(container, options);
    })();

    /* 네비 모드 색상 전환 */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;

      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
          strokeWeight: isNavigationMode ? 6 : 5
        });
      }
    };

    /* ================================
       ⭐ 추천 경로 그리기
       ================================ */
    window.showRecommendedRoute = function(routeData) {
      if (!routeData || !Array.isArray(routeData.polyline)) return;

      routeCoords = routeData.polyline.map(p => {
        return new kakao.maps.LatLng(Number(p.lat), Number(p.lng));
      });

      // 기존 제거
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);

      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });

      startMarker = new kakao.maps.Marker({
        map,
        position: routeCoords[0]
      });

      endMarker = new kakao.maps.Marker({
        map,
        position: routeCoords[routeCoords.length - 1]
      });

      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(c => bounds.extend(c));
      map.setBounds(bounds);
    };

    /* ================================
       ⭐ 지나온 길/남은 길 처리
       ================================ */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      const cur = new kakao.maps.LatLng(lat, lng);

      let idx = 0;
      let min = Infinity;

      routeCoords.forEach((p, i) => {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, p);
        if (d < min) {
          min = d;
          idx = i;
        }
      });

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);
    };

    /* ================================
       ⭐ 사용자 방향 + 위치 아이콘
       ================================ */
    window.updateRunnerOnRoute = function(lat, lng, headingDeg, onRoute) {
      const pos = new kakao.maps.LatLng(lat, lng);

      const color = (isNavigationMode && !(onRoute === true || onRoute === "true"))
        ? '#E53935'     // 이탈 시: 빨강
        : '#1E88E5';    // 정상: 파랑

      /* ⭐ 삼각형 아래로 -18px (top: calc(50% + 18px)) */
      const content = `
        <div class="user-dir-marker-outer" style="transform: rotate(${headingDeg}deg);">
          <div class="user-dir-marker-core" style="background:${color};"></div>
          <div class="user-dir-marker-arrow-wrap">
            <div class="user-dir-marker-arrow"></div>
          </div>
        </div>
      `;

      if (!userDirectionOverlay) {
        userDirectionOverlay = new kakao.maps.CustomOverlay({
          map,
          position: pos,
          content,
          zIndex: 10
        });
      } else {
        userDirectionOverlay.setPosition(pos);
        userDirectionOverlay.setContent(content);
      }
    };

    /* 숨기기 */
    window.hideRunnerOnRoute = function() {
      if (userDirectionOverlay) {
        userDirectionOverlay.setMap(null);
        userDirectionOverlay = null;
      }
    };
  </script>
</body>
</html>
