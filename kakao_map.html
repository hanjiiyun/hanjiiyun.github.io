<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
    }
    #map { width:100%; height:100vh; }

    /* ==========================================
       ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
       ========================================== */
    .runner-wrapper {
      position: absolute;
      transform: translate3d(0,0,0);
      transition: transform 0.18s linear; /* ğŸ”¥ í•µì‹¬: ìì—°ìŠ¤ëŸ¬ìš´ ì´ë™ */
      will-change: transform;
      pointer-events:none;
    }

    .user-dir-marker-outer {
      width: 34px;      /* ğŸ”¹ ë„¤ì´ë²„ë§µ í¬ê¸° ëŠë‚Œ */
      height: 34px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.28);  /* íŒŒë€ ë²ˆì§ */
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: transform 0.18s linear;     /* íšŒì „ ë¶€ë“œëŸ½ê²Œ */
      will-change: transform;
    }

    .user-dir-marker-core {
      width: 16px;      /* ğŸ”¹ ë™ê·¸ë¼ë¯¸ ì¡°ê¸ˆ ë” ì‘ê²Œ (ë„¤ì´ë²„ ë¹„ìŠ·) */
      height: 16px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      position: relative;
    }

    /* ì‚¼ê°í˜• ì‚´ì§ ìœ„ë¡œ ë„ìš°ê¸° */
    .user-dir-marker-arrow {
      position: absolute;
      top: -14px;  /* ğŸ”¥ ì› ë°–ìœ¼ë¡œ ì™„ì „íˆ ì˜¬ë¦¬ê¸° */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 12px solid white; /* ìœ„ìª½ ë°©í–¥ */
    }

    /* ğŸ†• í´ë¦¬ë¼ì¸ ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ (ì‘ì€ ì‚¼ê°í˜•) */
    .route-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 8px solid #1976D2; /* ë„¤ë¹„ íŒŒë€ìƒ‰ */
    }

  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ==========================================
       ì „ì—­ ë³€ìˆ˜
    ========================================== */
    let map;

    let routeCoords = [];
    let routeLineDone = null;
    let routeLineRemain = null;

    let startMarker = null;
    let endMarker = null;

    let runnerOverlay = null;    // wrapper + ì•„ì´ì½˜
    let runnerWrapperDiv = null;

    let isNavigationMode = false;

    // ğŸ†• í™”ì‚´í‘œ ì˜¤ë²„ë ˆì´ë“¤
    let routeArrows = [];

    // ğŸ†• ê¸°ë³¸ ì§€ë„ ë ˆë²¨ ì €ì¥ (ë„¤ë¹„ ëª¨ë“œ ëë‚˜ë©´ ë³µì›)
    let defaultMapLevel = 3;

    /* ==========================================
       ì§€ë„ ì´ˆê¸°í™”
    ========================================== */
    function initMap() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      });
      defaultMapLevel = map.getLevel(); // ğŸ†• í˜„ì¬ ë ˆë²¨ ì €ì¥
      console.log("ğŸ—º ì§€ë„ ì´ˆê¸°í™”ë¨");
    }
    initMap();

    /* ==========================================
       ğŸ” í´ë¦¬ë¼ì¸ ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
    ========================================== */
    function createRouteArrows(coords) {
      // ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }
      if (!coords || coords.length < 2) return;

      // ë„ˆë¬´ ë§ì´ ì°íˆì§€ ì•Šê²Œ ê°„ê²© ì¡°ì ˆ (ìµœëŒ€ 25ê°œ ì •ë„)
      const maxArrows = 25;
      const step = Math.max(1, Math.floor(coords.length / maxArrows));

      for (let i = 0; i < coords.length - 1; i += step) {
        const p1 = coords[i];
        const p2 = coords[i + 1];

        const dx = p2.getLng() - p1.getLng();
        const dy = p2.getLat() - p1.getLat();
        const angleRad = Math.atan2(dy, dx);
        const angleDeg = angleRad * 180 / Math.PI;

        const html =
          `<div class="route-arrow" style="
              transform: rotate(${angleDeg + 90}deg);
              transform-origin: 50% 50%;
            "></div>`;

        const overlay = new kakao.maps.CustomOverlay({
          position: p1,
          content: html,
          zIndex: 4
        });
        overlay.setMap(map);
        routeArrows.push(overlay);
      }
    }

    /* ==========================================
       ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ ìƒ‰ìƒë³€ê²½ + í™•ëŒ€
    ========================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;
      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
          strokeWeight: isNavigationMode ? 6 : 5
        });
      }

      // ğŸ†• ë„¤ë¹„ ëª¨ë“œì¼ ë•Œ ì‚´ì§ í™•ëŒ€, ì¢…ë£Œ ì‹œ ì›ë˜ëŒ€ë¡œ
      if (map) {
        if (isNavigationMode) {
          // ìˆ«ì ì‘ì„ìˆ˜ë¡ ë” í™•ëŒ€ë¨ (1ì´ ì œì¼ ê°€ê¹Œì›€)
          map.setLevel(2);   // ì§€ê¸ˆ 3ì´ë‹ˆê¹Œ í•œ ë‹¨ê³„ ë” í™•ëŒ€
        } else {
          map.setLevel(defaultMapLevel);
        }
      }
    };

    /* ==========================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    ========================================== */
    window.showRecommendedRoute = function(data) {
      if (!data || !Array.isArray(data.polyline)) return;

      routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // ë‚¨ì€ ê¸¸
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);

      // ì§€ë‚œ ê¸¸ (ì´ˆê¸°: ë¹„ì–´ìˆìŒ)
      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });

      // ì¶œë°œ/ë„ì°©
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0]
      });
      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1]
      });

      // ì „ì²´ ë³´ê¸°
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);

      // ğŸ†• ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
      createRouteArrows(routeCoords);
    };

    /* ==========================================
       ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸ ì—…ë°ì´íŠ¸
    ========================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      let idx = 0;
      let minDist = Infinity;
      const cur = new kakao.maps.LatLng(lat, lng);

      // ê°€ì¥ ê°€ê¹Œìš´ ì§€ì  ì°¾ê¸°
      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);

      // ğŸ” í™”ì‚´í‘œëŠ” ì²˜ìŒ ê·¸ë¦° ì „ì²´ ì½”ìŠ¤ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‘ê³ ,
      // êµ³ì´ ë§¤ë²ˆ ë‹¤ì‹œ ê³„ì‚° ì•ˆ í•´ë„ ë¼ì„œ ì—¬ê¸°ì„  ê±´ë“œë¦¬ì§€ ì•ŠìŒ.
    };

    /* ==========================================
       Follow Mode (ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°)
    ========================================== */
    window.followUser = function(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);   // ğŸ”¥ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ê°
    };

    /* ==========================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸(ë¶€ë“œëŸ¬ìš´ ì´ë™)
    ========================================== */
    window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {

      const pos = new kakao.maps.LatLng(lat, lng);
      const proj = map.getProjection();
      const point = proj.containerPointFromCoords(pos);

      const color = (onRoute === true || onRoute === "true")
        ? "#1E88E5"
        : "#E53935";

      const h = Number(heading || 0);
      const offsetDeg = -18; /* ğŸ”¥ ì§€ìœ¤ì´ê°€ ë§í•œ ê°ë„ ë³´ì • */

      // ìµœì´ˆ ìƒì„±
      if (!runnerOverlay) {

        runnerWrapperDiv = document.createElement("div");
        runnerWrapperDiv.className = "runner-wrapper";

        const html = `
          <div class="user-dir-marker-outer" id="runnerOuter">
            <div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
            <div class="user-dir-marker-arrow"></div>
          </div>
        `;

        runnerWrapperDiv.innerHTML = html;

        runnerOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: runnerWrapperDiv,
          zIndex: 5
        });
        runnerOverlay.setMap(map);

      } else {
        runnerOverlay.setPosition(pos);
      }

      // ğŸ¯ CSS transform ê¸°ë°˜ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ë™
      runnerWrapperDiv.style.transform =
        `translate3d(${point.x - 17}px, ${point.y - 17}px, 0)`; // ì¤‘ì‹¬ ë§ì¶¤

      // íšŒì „
      const outer = runnerWrapperDiv.querySelector("#runnerOuter");
      outer.style.transform = `rotate(${h + offsetDeg}deg)`;

      // ìƒ‰ìƒ ë³€ê²½
      const core = runnerWrapperDiv.querySelector("#runnerCore");
      core.style.background = color;
    };


    /* ==========================================
       ëŸ¬ë„ˆ ìˆ¨ê¸°ê¸°
    ========================================== */
    window.hideRunnerOnRoute = function() {
      if (runnerOverlay) {
        runnerOverlay.setMap(null);
        runnerOverlay = null;
      }
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }
    };
  </script>
</body>
</html>
