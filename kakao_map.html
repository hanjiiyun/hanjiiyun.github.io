<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>R2U Kakao Map</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    /* â­ í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜ (íšŒì „ìš©) */
    .user-dir-marker {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background-color: #00C853;
      border: 3px solid white;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .user-dir-marker-inner {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid white; /* ì‘ì€ ì‚¼ê°í˜• í™”ì‚´í‘œ */
      transform: translateY(-1px);
    }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf"></script>
</head>
<body>
  <div id="map"></div>

  <script>
  // ì „ì—­ ë³€ìˆ˜
  var map;
  var routeLine = null;
  var startMarker = null;
  var endMarker = null;
  var userMarker = null;           // íŒŒë€ í•€
  var userDirectionOverlay = null; // â­ í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜
  var lastHeadingDeg = 0;

  // ì§€ë„ ìƒì„±
  (function initMap() {
    const container = document.getElementById('map');
    const options = {
      center: new kakao.maps.LatLng(37.4507, 126.6530),
      level: 3
    };
    map = new kakao.maps.Map(container, options);
    console.log("ğŸ—º map ì´ˆê¸°í™” ì™„ë£Œ");
  })();

  // Flutterì—ì„œ í˜¸ì¶œ: ì¶”ì²œ ê²½ë¡œ
  window.showRecommendedRoute = function(routeData) {
    console.log("ğŸ“¡ showRecommendedRoute í˜¸ì¶œë¨:", routeData);

    if (!routeData || !Array.isArray(routeData.polyline)) {
      console.log("âš  polyline ë°°ì—´ ì—†ìŒ");
      return;
    }

    var linePath = routeData.polyline.map(function(p) {
      var lat = Number(p.lat);
      var lng = Number(p.lng);
      return new kakao.maps.LatLng(lat, lng);
    });

    if (linePath.length === 0) {
      console.log("âš  linePath ë¹„ì–´ ìˆìŒ");
      return;
    }

    if (routeLine) routeLine.setMap(null);
    if (startMarker) startMarker.setMap(null);
    if (endMarker) endMarker.setMap(null);

    routeLine = new kakao.maps.Polyline({
      map: map,
      path: linePath,
      strokeWeight: 5,
      strokeColor: '#00C853',
      strokeOpacity: 0.9,
      strokeStyle: 'solid'
    });

    var startPos = linePath[0];
    var endPos = linePath[linePath.length - 1];

    startMarker = new kakao.maps.Marker({
      map: map,
      position: startPos
    });

    endMarker = new kakao.maps.Marker({
      map: map,
      position: endPos
    });

    var bounds = new kakao.maps.LatLngBounds();
    linePath.forEach(function(pos) {
      bounds.extend(pos);
    });
    map.setBounds(bounds);

    console.log("âœ… í´ë¦¬ë¼ì¸/ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ");
  };

  // Flutterì—ì„œ í˜¸ì¶œ: í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (íŒŒë€ í•€)
 // Flutterì—ì„œ í˜¸ì¶œ: í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (íŒŒë€ í•€)
window.showUserLocation = function(lat, lng) {
  console.log("ğŸ“¡ showUserLocation í˜¸ì¶œë¨:", lat, lng);

  if (!map) {
    console.log("âŒ map ê°ì²´ ì—†ìŒ");
    return;
  }

  var nLat = Number(lat);
  var nLng = Number(lng);
  if (isNaN(nLat) || isNaN(nLng)) {
    console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨:", lat, lng);
    return;
  }

  var pos = new kakao.maps.LatLng(nLat, nLng);

  if (!userMarker) {
    userMarker = new kakao.maps.Marker({
      map: map,
      position: pos,
      zIndex: 3
    });
    console.log("âœ… userMarker ìƒì„±");
  } else {
    userMarker.setPosition(pos);
    console.log("âœ… userMarker ìœ„ì¹˜ ê°±ì‹ ");
  }

  // â­ ì¶”ì²œ ì‹œì‘ ì „(= ì•„ì§ routeLine ì—†ìŒ)ì—ëŠ”
  //    í˜„ì¬ ìœ„ì¹˜ë¥¼ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ë”°ë¼ê°€ê²Œ
  if (!routeLine) {
    map.setCenter(pos);
  }
};


  // â­ Flutterì—ì„œ í˜¸ì¶œ: í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜(ë°©í–¥ í‘œì‹œ) ì—…ë°ì´íŠ¸
  window.updateRunnerOnRoute = function(lat, lng, headingDeg) {
    console.log("ğŸ“¡ updateRunnerOnRoute:", lat, lng, headingDeg);

    if (!map) {
      console.log("âŒ map ê°ì²´ ì—†ìŒ (updateRunnerOnRoute)");
      return;
    }

    var nLat = Number(lat);
    var nLng = Number(lng);
    var nHeading = Number(headingDeg);

    if (isNaN(nLat) || isNaN(nLng)) {
      console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ (runner):", lat, lng);
      return;
    }
    if (isNaN(nHeading)) {
      nHeading = 0;
    }

    lastHeadingDeg = nHeading;

    var pos = new kakao.maps.LatLng(nLat, nLng);

    // CSSë¡œ íšŒì „ ì ìš©
    var content =
      '<div class="user-dir-marker" style="transform: rotate(' + nHeading + 'deg);">' +
        '<div class="user-dir-marker-inner"></div>' +
      '</div>';

    if (!userDirectionOverlay) {
      userDirectionOverlay = new kakao.maps.CustomOverlay({
        position: pos,
        content: content,
        zIndex: 5
      });
      userDirectionOverlay.setMap(map);
      console.log("âœ… userDirectionOverlay ìƒì„±");
    } else {
      userDirectionOverlay.setPosition(pos);
      userDirectionOverlay.setContent(content);
      console.log("âœ… userDirectionOverlay ê°±ì‹ ");
    }
  };

  // â­ Flutterì—ì„œ í˜¸ì¶œ: ëŸ¬ë„ˆ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸° (ì½”ìŠ¤ ì´íƒˆ/ì½”ìŠ¤ ì—†ìŒ)
  window.hideRunnerOnRoute = function() {
    console.log("ğŸ“¡ hideRunnerOnRoute í˜¸ì¶œë¨");
    if (userDirectionOverlay) {
      userDirectionOverlay.setMap(null);
      userDirectionOverlay = null;
    }
  };
  </script>
</body>
</html>
