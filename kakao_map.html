<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
    }
    #map { width:100%; height:100vh; }

    /* ==========================================
       ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
       ========================================== */
    .runner-wrapper {
      position: absolute;
      transform: translate3d(0,0,0);
      transition: transform 0.18s linear; /* ğŸ”¥ í•µì‹¬: ìì—°ìŠ¤ëŸ¬ìš´ ì´ë™ */
      will-change: transform;
      pointer-events:none;
    }

    .user-dir-marker-outer {
      width: 34px;      /* ğŸ”¹ ë„¤ì´ë²„ë§µ í¬ê¸° ëŠë‚Œ */
      height: 34px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.28);  /* íŒŒë€ ë²ˆì§ */
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: transform 0.18s linear;     /* íšŒì „ ë¶€ë“œëŸ½ê²Œ */
      will-change: transform;
    }

    .user-dir-marker-core {
      width: 16px;      /* ğŸ”¹ ë™ê·¸ë¼ë¯¸ ì¡°ê¸ˆ ë” ì‘ê²Œ (ë„¤ì´ë²„ ë¹„ìŠ·) */
      height: 16px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      position: relative;
    }

    /* ì‚¼ê°í˜• ì‚´ì§ ìœ„ë¡œ ë„ìš°ê¸° */
    .user-dir-marker-arrow {
      position: absolute;
      top: -14px;  /* ğŸ”¥ ì› ë°–ìœ¼ë¡œ ì™„ì „íˆ ì˜¬ë¦¬ê¸° */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 12px solid white; /* ìœ„ìª½ ë°©í–¥ */
    }

  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ==========================================
       ì „ì—­ ë³€ìˆ˜
    ========================================== */
    let map;

    let routeCoords = [];
    let routeLineDone = null;
    let routeLineRemain = null;

    let startMarker = null;
    let endMarker = null;

    let runnerOverlay = null;    // wrapper + ì•„ì´ì½˜
    let runnerWrapperDiv = null;

    let isNavigationMode = false;

    /* ==========================================
       ì§€ë„ ì´ˆê¸°í™”
    ========================================== */
    function initMap() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      });
      console.log("ğŸ—º ì§€ë„ ì´ˆê¸°í™”ë¨");
    }
    initMap();

    /* ==========================================
       ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ ìƒ‰ìƒë³€ê²½
    ========================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;
      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
          strokeWeight: isNavigationMode ? 6 : 5
        });
      }
    };

    /* ==========================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    ========================================== */
    window.showRecommendedRoute = function(data) {
      if (!data || !Array.isArray(data.polyline)) return;

      routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      // ë‚¨ì€ ê¸¸
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);

      // ì§€ë‚œ ê¸¸ (ì´ˆê¸°: ë¹„ì–´ìˆìŒ)
      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });

      // ì¶œë°œ/ë„ì°©
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0]
      });
      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1]
      });

      // ì „ì²´ ë³´ê¸°
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);
    };

    /* ==========================================
       ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸ ì—…ë°ì´íŠ¸
    ========================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      let idx = 0;
      let minDist = Infinity;
      const cur = new kakao.maps.LatLng(lat, lng);

      // ê°€ì¥ ê°€ê¹Œìš´ ì§€ì  ì°¾ê¸°
      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);
    };

    /* ==========================================
       Follow Mode (ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°)
    ========================================== */
    window.followUser = function(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);   // ğŸ”¥ ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ê°
    };

    /* ==========================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸(ë¶€ë“œëŸ¬ìš´ ì´ë™)
    ========================================== */
    window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {

  const pos = new kakao.maps.LatLng(lat, lng);

  const color = (onRoute === true || onRoute === "true")
    ? "#1E88E5"
    : "#E53935";

  const h = Number(heading || 0);
  const offsetDeg = -18;

  if (!runnerOverlay) {
    runnerWrapperDiv = document.createElement("div");
    runnerWrapperDiv.className = "runner-wrapper";

    const html = `
      <div class="user-dir-marker-outer" id="runnerOuter">
        <div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
        <div class="user-dir-marker-arrow"></div>
      </div>
    `;
    runnerWrapperDiv.innerHTML = html;

    runnerOverlay = new kakao.maps.CustomOverlay({
      position: pos,
      content: runnerWrapperDiv,
      zIndex: 5
    });
    runnerOverlay.setMap(map);
  } else {
    runnerOverlay.setPosition(pos);
  }

  const outer = runnerWrapperDiv.querySelector("#runnerOuter");
  outer.style.transform = `rotate(${h + offsetDeg}deg)`;

  const core = runnerWrapperDiv.querySelector("#runnerCore");
  core.style.background = color;
};


    /* ==========================================
       ëŸ¬ë„ˆ ìˆ¨ê¸°ê¸°
    ========================================== */
    window.hideRunnerOnRoute = function() {
      if (runnerOverlay) {
        runnerOverlay.setMap(null);
        runnerOverlay = null;
      }
    };
  </script>
</body>
</html>
