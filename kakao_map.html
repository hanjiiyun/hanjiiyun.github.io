<!doctype html> 
<html lang="ko">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
	<title>R2U Kakao Map</title>

	<style>
		html, body {
			margin:0;
			padding:0;
			height:100%;
			overflow:hidden;
		}
		#map { width:100%; height:100vh; }

		/* ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ */
		.runner-wrapper {
			position: absolute;
			transform: translate(-50%, -50%); Â /* ì¤‘ì‹¬ì´ ì¢Œí‘œì— ë”± ì˜¤ë„ë¡ */
			/* ğŸš¨ í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸ë¥¼ ì§€ë„ì— ì „ë‹¬í•˜ë„ë¡ ì„¤ì • (CSSëŠ” ìœ íš¨í•¨) */
			pointer-events:none; 
		}

		.user-dir-marker-outer {
			width: 34px;
			height: 34px;
			border-radius: 50%;
			background: rgba(33, 150, 243, 0.28);
			display: flex;
			align-items: center;
			justify-content: center;
			box-sizing: border-box;
			transition: transform 0.18s linear;
			will-change: transform;
		}

		.user-dir-marker-core {
			width: 16px;
			height: 16px;
			border-radius: 50%;
			background: #1E88E5;
			border: 3px solid #FFFF;
			box-shadow: 0 0 5px rgba(0,0,0,0.4);
			position: relative;
		}

		.user-dir-marker-arrow {
			position: absolute;
			top: -14px;
			left: 50%;
			transform: translateX(-50%);
			width: 0;
			height: 0;
			border-left: 6px solid transparent;
			border-right: 6px solid transparent;
			border-bottom: 12px solid #1E88E5;
		}

		/* ì½”ìŠ¤ ìœ„ ë°©í–¥ í™”ì‚´í‘œ (ì¶œë°œ/í„´ ì§€ì ìš©) */
		.route-arrow {
			width: 0;
			height: 0;
			border-left: 8px solid transparent;
			border-right: 8px solid transparent;
			border-bottom: 16px solid #00FA73; /* ê¸°ë³¸: í˜•ê´‘ì´ˆë¡ */
			filter: drop-shadow(0 0 3px rgba(0,0,0,0.8));
		}
	</style>

	<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry,geometry"></script>
</head>

<body>
	<div id="map"></div>

	<script>
		/* ========= ì „ì—­ ========= */
		window.r2uOffRouteWarned = false; Â  // (ë¯¸ì‚¬ìš© ì˜ˆì „ í”Œë˜ê·¸)
		window.r2uBackToRouteWarned = false;

		// â­ ì¶”ê°€: ê²½ë¡œ ì§„í–‰/ì´íƒˆ ê´€ë ¨ ì „ì—­ í”Œë˜ê·¸
		window.r2uIsOffRoute = false; Â  Â  Â  // í˜„ì¬ ê²½ë¡œ ì´íƒˆ ì—¬ë¶€
		window.r2uLastOffRouteSpoken = false; // ì´íƒˆ ì•ˆë‚´ í•œ ë²ˆë§Œ ì½ê¸°
		window.r2uLastIdx = 0; Â  Â  Â  Â  Â  Â  Â // ì§„í–‰ ì¸ë±ìŠ¤ ì•ˆì •í™”ìš©

		let map;

		let routeCoords = []; Â // Polyline ì¢Œí‘œ (í„´ ê³„ì‚°ìš©)
		
		// ğŸš¨ ìˆ˜ì •: ê¸°ì¡´ Polyline ì¸ìŠ¤í„´ìŠ¤ë“¤ì„ ëª¨ë‘ ë‹´ì„ ë°°ì—´ë¡œ ë³€ê²½ (ì„¸ê·¸ë¨¼íŠ¸ ë‹¨ìœ„)
		let routePolylines = []; Â // ëª¨ë“  ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ Polyline ì¸ìŠ¤í„´ìŠ¤ (ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸)
		
		let routeLineBase = null; Â  // í°ìƒ‰ ë‘êº¼ìš´ ë² ì´ìŠ¤ (ë„¤ë¹„ ëª¨ë“œ)

		let startMarker = null;
		let endMarker = null;

		let runnerOverlay = null;
		let runnerWrapperDiv = null;

		let isNavigationMode = false;
		let defaultMapLevel = 3;

		let routeArrows = []; // ë°©í–¥ í™”ì‚´í‘œë“¤
		let routeTurns = []; Â // â­ í„´ ìœ„ì¹˜ ì •ë³´ (ì¢Œ/ìš°íšŒì „ ì§€ì )



		/* ========= ì§€ë„ ì´ˆê¸°í™” ========= */
		function initMap() {
			const container = document.getElementById('map');
			map = new kakao.maps.Map(container, {
				center: new kakao.maps.LatLng(37.4507, 126.6530),
				level: 3
			});
			defaultMapLevel = map.getLevel();
		}
		initMap();

		/* ========= ë°©í–¥ í™”ì‚´í‘œ ========= */
		function createRouteArrows(coords) {
			if (!kakao.maps.geometry || !kakao.maps.geometry.spherical) {
				return;
			}
			// ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
			if (routeArrows.length) {
				routeArrows.forEach(a => a.setMap(null));
				routeArrows = [];
			}
			if (!coords || coords.length < 2) return;

			// 2ï¸âƒ£ í„´ ì§€ì  í™”ì‚´í‘œ (ì¢Œ/ìš°íšŒì „ ì§€ì ì—ë§Œ)
			if (routeTurns && routeTurns.length) {
				routeTurns.forEach(turn => {
					const tLat = turn.lat;
					const tLng = turn.lng;
					if (typeof tLat !== 'number' || typeof tLng !== 'number') return;

					const pos = new kakao.maps.LatLng(tLat, tLng);

					// ì´ í„´ ìœ„ì¹˜ì™€ ê°€ì¥ ê°€ê¹Œìš´ polyline segment ì°¾ê¸°
					let nearestIdx = 0;
					let minDist = Infinity;
					for (let i = 0; i < coords.length; i++) {
						const d = kakao.maps.geometry.spherical.computeDistanceBetween(
							pos,
							coords[i]
						);
						if (d < minDist) {
							minDist = d;
							nearestIdx = i;
						}
					}

					const baseIdx = Math.min(nearestIdx, coords.length - 2);
					const segP1 = coords[baseIdx];
					const segP2 = coords[baseIdx + 1];

					const dx = segP2.getLng() - segP1.getLng();
					const dy = segP2.getLat() - segP1.getLat();
					const angleRad = Math.atan2(dy, dx);
					const angleDeg = angleRad * 180 / Math.PI;
					const rotateDeg = angleDeg - 90;

					// íƒ€ì…ë³„ ìƒ‰ìƒ (ì¢Œ/ìš°íšŒì „ êµ¬ë¶„ìš©)
					let color = '#FFFFFF';
					if (turn.type === 'left') {
						color = '#FF7043'; Â  // ì¢ŒíšŒì „: ì£¼í™©
					} else if (turn.type === 'right') {
						color = '#42A5F5'; Â  // ìš°íšŒì „: íŒŒë‘
					} else {
						color = '#FFFFFF'; Â  // ì§ì§„/ê¸°íƒ€
					}

					const html =
						`<div class="route-arrow" style="
							transform: rotate(${rotateDeg}deg);
							transform-origin: 50% 50%;
							border-bottom-color: ${color};
						"></div>`;

					const overlay = new kakao.maps.CustomOverlay({
						position: pos,
						content: html,
						zIndex: 5
					});
					overlay.setMap(map);
					routeArrows.push(overlay);
				});
			}
		}

		/* ========= ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ on/off ========= */
		window.setNavigationMode = function(isNav) {
			isNavigationMode = !!isNav;

			if (isNavigationMode) {
				// ì¶œë°œì ìª½ í™•ëŒ€
				if (map && routeCoords.length > 0) {
					const startPos = routeCoords[0];
					map.setLevel(2); Â  Â  Â  // í™•ëŒ€
					map.panTo(startPos); Â  // ì¶œë°œì  ê¸°ì¤€
				} else if (map) {
					map.setLevel(2);
				}

				// í°ìƒ‰ ë² ì´ìŠ¤ ë¼ì¸ (routeCoordsë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë²ˆë§Œ ê·¸ë¦¼)
				if (routeCoords.length && !routeLineBase) {
					routeLineBase = new kakao.maps.Polyline({
						path: routeCoords,
						strokeWeight: 10,
						strokeColor: '#FFFFFF',
						strokeOpacity: 0.9,
						strokeStyle: 'solid',
						zIndex: 1, // ê°€ì¥ ì•„ë˜ì— ë°°ì¹˜
					});
					routeLineBase.setMap(map);
				}

				// ë°©í–¥ í™”ì‚´í‘œ ìƒì„± (ì¶œë°œ + í„´ ì§€ì ë§Œ)
				createRouteArrows(routeCoords);
			}
			else {
				// ë„¤ë¹„ ì¢…ë£Œ â†’ ì¼ë°˜ ëª¨ë“œ
				if (map) {
					map.setLevel(defaultMapLevel);
				}

				// ëŸ¬ë„ˆ/ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬ (ì¬ì‚¬ìš© ì—†ì´ ëª¨ë‘ ì œê±°)
				hideRunnerOnRoute();
			}
		};
		
		/**
		 * ê²½ë¡œ í´ë¦¬ë¼ì¸ì„ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
		 */
		function clearRoutePolylines() {
			routePolylines.forEach(polyline => polyline.setMap(null));
			routePolylines = [];
		}
		
		/**
		 * ğŸš¨ Flutterì—ì„œ í˜¸ì¶œ: ì„¸ê·¸ë¨¼íŠ¸ ëª©ë¡ì„ ë°›ì•„ ê²½ë¡œë¥¼ ê·¸ë¦½ë‹ˆë‹¤. (ìƒ‰ìƒ ì—…ë°ì´íŠ¸ìš©)
		 * ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´ ê¸°ì¡´ ê²½ë¡œ ì„ ì€ ëª¨ë‘ ì§€ìš°ê³ , isPassed ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒì„ ì…íŒ
		 * ìƒˆë¡œìš´ ì„¸ê·¸ë¨¼íŠ¸ ë¼ì¸ì„ ê·¸ë¦½ë‹ˆë‹¤.
		 * @param {Array<Object>} segments - RouteSegment ê°ì²´ ë°°ì—´
		 */
		window.updateRouteSegments = function(segments) {
			if (!segments || segments.length === 0) {
				console.warn("JS: ì—…ë°ì´íŠ¸í•  ì„¸ê·¸ë¨¼íŠ¸ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
				return;
			}
			
			// ê¸°ì¡´ ì„¸ê·¸ë¨¼íŠ¸ ë¼ì¸ ì œê±° (routeLineBaseëŠ” ë‚¨ê²¨ë‘ )
			clearRoutePolylines(); 
			
			// ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì— ëŒ€í•´ ê°œë³„ í´ë¦¬ë¼ì¸ì„ ê·¸ë¦½ë‹ˆë‹¤.
			segments.forEach(segment => {
				// ğŸš¨ ìˆ˜ì •: isPassed ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ê²°ì •
				const color = segment.isPassed ? '#555555' : '#8BC34A'; // íšŒìƒ‰ : ì—°ë‘ìƒ‰
				const weight = isNavigationMode ? 8 : 6;

				const linePath = [
					new kakao.maps.LatLng(segment.startPoint.lat, segment.startPoint.lng),
					new kakao.maps.LatLng(segment.endPoint.lat, segment.endPoint.lng)
				];

				const polyline = new kakao.maps.Polyline({
					path: linePath,
					strokeWeight: weight, 
					strokeColor: color, 
					strokeOpacity: 0.96,
					strokeStyle: 'solid',
					zIndex: 3, // í°ìƒ‰ ë² ì´ìŠ¤(1)ë³´ë‹¤ ë†’ê²Œ, ë§ˆì»¤/í™”ì‚´í‘œ(5)ë³´ë‹¤ ë‚®ê²Œ 
				});

				polyline.setMap(map);
				routePolylines.push(polyline);
			});
		}

		/* ========= ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸° ========= */
		window.showRecommendedRoute = function(data) {
			// â­ í„´ ê³„ì‚°ìš©ìœ¼ë¡œ ì‚¬ìš©í•  routeCoords ìƒì„± (ì´ì „ polyline êµ¬ì¡°ë¥¼ ê°€ì •)
			routeCoords = [];
			if (Array.isArray(data.polyline)) {
				routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));
			} else if (Array.isArray(data.segments)) {
				// segmentsê°€ ìˆëŠ” ê²½ìš°, routeCoordsë¥¼ ì¬êµ¬ì„±
				data.segments.forEach((seg, i) => {
					if (i === 0) {
						routeCoords.push(new kakao.maps.LatLng(seg.startPoint.lat, seg.startPoint.lng));
					}
					routeCoords.push(new kakao.maps.LatLng(seg.endPoint.lat, seg.endPoint.lng));
				});
			} else {
				return;
			}


			// â­ í„´ ì •ë³´ ì €ì¥ (ì¢Œ/ìš°íšŒì „ ì§€ì )
			routeTurns = [];
			if (Array.isArray(data.turns)) {
				data.turns.forEach(t => {
					// 1) lat/lngê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
					if (typeof t.lat === 'number' && typeof t.lng === 'number') {
						routeTurns.push({
							lat: t.lat,
							lng: t.lng,
							type: t.type || 'straight',
							atDistM: t.atDistM || null,
							instruction: t.instruction || "",
						});
					}
					// 2) lat/lngê°€ ì—†ê³  atDistMë§Œ ìˆìœ¼ë©´, polyline ìœ„ì—ì„œ ìœ„ì¹˜ ê³„ì‚° (routeCoordsê°€ í•„ìˆ˜)
					else if (typeof t.atDistM === 'number' && routeCoords.length > 1) {
						if (!kakao.maps.geometry || !kakao.maps.geometry.spherical) {
							return;
						}

						const target = t.atDistM;
						let acc = 0;
						for (let i = 0; i < routeCoords.length - 1; i++) {
							const segLen = kakao.maps.geometry.spherical.computeDistanceBetween(
								routeCoords[i],
								routeCoords[i + 1]
							);
							if (acc + segLen >= target) {
								const ratio = (target - acc) / segLen;
								const lat =
									routeCoords[i].getLat() +
									(routeCoords[i + 1].getLat() - routeCoords[i].getLat()) * ratio;
								const lng =
									routeCoords[i].getLng() +
									(routeCoords[i + 1].getLng() - routeCoords[i].getLng()) * ratio;
								routeTurns.push({
									lat: lat,
									lng: lng,
									type: t.type || 'straight',
									atDistM: t.atDistM,
									instruction: t.instruction || "",
								});
								break;
							}
							acc += segLen;
						}
					}
				});
			}

			// ê¸°ì¡´ ë¼ì¸/ë§ˆì»¤/í™”ì‚´í‘œ ì œê±° (hideRunnerOnRoute í•¨ìˆ˜ ì¬ì‚¬ìš©)
			window.hideRunnerOnRoute(); 
			
			// ğŸš¨ ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ ì´ˆê¸°í™” (segments ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©)
			if (Array.isArray(data.segments)) {
				window.updateRouteSegments(data.segments);
			} else {
				// segmentsê°€ ì—†ìœ¼ë©´, ì „ì²´ ì´ˆë¡ìƒ‰ ë¼ì¸ í•˜ë‚˜ë§Œ ê·¸ë¦½ë‹ˆë‹¤.
				const polyline = new kakao.maps.Polyline({
					path: routeCoords,
					strokeWeight: 6,
					strokeColor: '#00FF7F',
					strokeOpacity: 0.96,
					strokeStyle: 'solid',
					zIndex: 3,
				});
				polyline.setMap(map);
				routePolylines.push(polyline);
			}

			// ì¶œë°œ/ë„ì°© ë§ˆì»¤
			if (routeCoords.length > 0) {
				startMarker = new kakao.maps.Marker({
					map: map,
					position: routeCoords[0],
				});
				endMarker = new kakao.maps.Marker({
					map: map,
					position: routeCoords[routeCoords.length - 1],
				});
				
				// âœ… ì½”ìŠ¤ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì¶•ì†Œ/ì´ë™
				const bounds = new kakao.maps.LatLngBounds();
				routeCoords.forEach(p => bounds.extend(p));
				map.setBounds(bounds);
			}


			window.r2uCourse = data;
			window.r2uTurns = routeTurns || [];
			window.r2uSpokenTurnIds = new Set();
			window.r2uLastIdx = 0;
			window.r2uIsOffRoute = false;
			window.r2uLastOffRouteSpoken = false;
		};

		
		/**
		 * ğŸš¨ ìˆ˜ì •: ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ê²½ë¡œ ì§„í–‰ì„ ì—…ë°ì´íŠ¸í•˜ì§€ ì•Šê³ , TTS ì²´í¬ì™€ ê²½ë¡œ ì´íƒˆ ì•ˆë‚´ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤.
		 * ê²½ë¡œ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ëŠ” Flutterì—ì„œ `updateRouteSegments`ë¥¼ í†µí•´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
		 */
		window.updateRouteProgress = function(lat, lng) {
			if (!routeCoords.length) return;
			if (!kakao.maps.geometry || !kakao.maps.geometry.spherical) return;

			// 1. TTS ì²´í¬ëŠ” ê³„ì† ìˆ˜í–‰
			r2uCheckTurnTts(lat, lng);
			
			// 2. ê²½ë¡œ ì´íƒˆ ê°ì§€ 15m ê¸°ì¤€ ë¡œì§ (TTS ì•ˆë‚´ìš©ìœ¼ë¡œ ìœ ì§€)
			const cur = new kakao.maps.LatLng(lat, lng);
			let minDist = Infinity;
			for (let i = 0; i < routeCoords.length; i++) {
				const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
				if (d < minDist) {
					minDist = d;
				}
			}
			
			let isOffRoute = minDist > 15;
			window.r2uIsOffRoute = isOffRoute; // ëŸ¬ë„ˆ ì•„ì´ì½˜ ìƒ‰ìƒ ë³€ê²½ì— ì‚¬ìš©

			if (isOffRoute) {
				if (!window.r2uLastOffRouteSpoken) {
					window.r2uLastOffRouteSpoken = true;

					const msg = "ê²½ë¡œì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";

					if (window.R2UTTS && window.R2UTTS.postMessage) {
						window.R2UTTS.postMessage(msg);
					}
					else if (typeof R2UTTS !== "undefined" && R2UTTS.postMessage) {
						R2UTTS.postMessage(msg);
					}
				}
			} else {
				// ê²½ë¡œ ë³µê·€ â†’ ì•ˆë‚´ ì´ˆê¸°í™”
				window.r2uLastOffRouteSpoken = false;
			}
		}

		/* ========= ì§€ë„ ìë™ ë”°ë¼ê°€ê¸° ========= */
		window.followUser = function(lat, lng) {
			const pos = new kakao.maps.LatLng(lat, lng);
			map.panTo(pos);
		};

		/* ========= ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ ========= */
		window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {
			if (!isNavigationMode) return;

			const pos = new kakao.maps.LatLng(lat, lng);

			// â­ ìˆ˜ì •: onRoute ë§¤ê°œë³€ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ìƒ‰ìƒ ê²°ì • (Dartì—ì„œ ê³„ì‚°í•œ ê°’ ì‚¬ìš©)
			// onRouteê°€ 'false' ë˜ëŠ” falseì¼ ê²½ìš° ì´íƒˆë¡œ ê°„ì£¼
			const offRouteFlag = !(onRoute === true || onRoute === "true"); 

			// ğŸš¨ ìˆ˜ì •: ì´íƒˆ í”Œë˜ê·¸ë¥¼ CSSì— ë°˜ì˜í•  ë•Œ, ëŸ¬ë„ˆ ì•„ì´ì½˜ì˜ ìƒ‰ìƒë„ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
			const color = offRouteFlag ? "#E53935" : "#1E88E5";

			const h = Number(heading || 0);
			const offsetDeg = 0;

			if (!runnerOverlay) {
				runnerWrapperDiv = document.createElement("div");
				runnerWrapperDiv.className = "runner-wrapper";

				// í™”ì‚´í‘œ ìƒ‰ìƒë„ ë™ì ìœ¼ë¡œ ì„¤ì •í•˜ë„ë¡ ìˆ˜ì •
				const html = `
					<div class="user-dir-marker-outer" id="runnerOuter">
						<div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
						<div class="user-dir-marker-arrow" style="border-bottom-color: ${color};"></div>
					</div>
				`;
				runnerWrapperDiv.innerHTML = html;

				runnerOverlay = new kakao.maps.CustomOverlay({
					position: pos,
					content: runnerWrapperDiv,
					zIndex: 5,
				});
				runnerOverlay.setMap(map);
			} else {
				runnerOverlay.setPosition(pos);
			}

			// íšŒì „
			const outer = runnerWrapperDiv.querySelector("#runnerOuter");
			if (outer) {
				outer.style.transform = `rotate(${h + offsetDeg}deg)`;
			}

			// ìƒ‰ìƒ (ì½”ì–´)
			const core = runnerWrapperDiv.querySelector("#runnerCore");
			if (core) {
				core.style.background = color;
			}
			// ìƒ‰ìƒ (í™”ì‚´í‘œ)
			const arrow = runnerWrapperDiv.querySelector(".user-dir-marker-arrow");
			if (arrow) {
				arrow.style.borderBottomColor = color;
			}
		};

		/* ========= ëŸ¬ë„ˆ/ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬ ========= */
		window.hideRunnerOnRoute = function() {
			if (runnerOverlay) {
				runnerOverlay.setMap(null);
				runnerOverlay = null;
			}
			runnerWrapperDiv = null;

			if (routeArrows.length) {
				routeArrows.forEach(a => a.setMap(null));
				routeArrows = [];
			}

			if (routeLineBase) {
				routeLineBase.setMap(null);
				routeLineBase = null;
			}
			
			// ğŸš¨ ìˆ˜ì •: ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ í´ë¦¬ë¼ì¸ ì œê±°
			clearRoutePolylines();
			
			if (startMarker) {
				startMarker.setMap(null);
				startMarker = null;
			}
			if (endMarker) {
				endMarker.setMap(null);
				endMarker = null;
			}

			routeCoords = [];
			routeTurns = [];
			window.r2uSpokenTurnIds = new Set();
			window.r2uLastIdx = 0;
			window.r2uIsOffRoute = false;
			window.r2uLastOffRouteSpoken = false;
		};

		window.r2uCourse = window.r2uCourse || null;
		window.r2uTurns = window.r2uTurns || [];
		window.r2uSpokenTurnIds = window.r2uSpokenTurnIds || new Set();

		// ê°„ë‹¨ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„)
		function r2uDistanceMeter(lat1, lng1, lat2, lng2) {
			const R = 6371000; // m
			const toRad = Math.PI / 180;
			const dLat = (lat2 - lat1) * toRad;
			const dLng = (lng2 - lng1) * toRad;
			const a =
				Math.sin(dLat / 2) * Math.sin(dLat / 2) +
				Math.cos(lat1 * toRad) *
					Math.cos(lat2 * toRad) *
					Math.sin(dLng / 2) * Math.sin(dLng / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			return R * c;
		}

		// âœ… ë‚´ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ "ì–´ë–¤ í„´ì„ ë§í•´ì•¼ í•˜ë‚˜" ì²´í¬
		function r2uCheckTurnTts(currentLat, currentLng) {
			if (!isNavigationMode) return;
			if (!window.r2uTurns || window.r2uTurns.length === 0) return;

			const THRESHOLD = 40; // ëª‡ m ì•ì—ì„œ ì½ì„ì§€

			for (let i = 0; i < window.r2uTurns.length; i++) {
				const t = window.r2uTurns[i];

				// ğŸ” í„´ ì¢Œí‘œ í•„ë“œ ì¶”ì¸¡: lat/lng ë˜ëŠ” latitude/longitude ë˜ëŠ” point.lat/point.lng
				const turnLat = t.lat ?? t.latitude ?? (t.point && t.point.lat);
				const turnLng = t.lng ?? t.longitude ?? (t.point && t.point.lng);
				if (turnLat == null || turnLng == null) continue;

				const turnId = t.id ?? i.toString();
				const dist = r2uDistanceMeter(currentLat, currentLng, turnLat, turnLng);

				// ğŸš¨ TTS ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€
				console.log(`TTS Check: Turn ${i} (${t.type || 'straight'}) at ${dist.toFixed(1)}m. Spoken: ${window.r2uSpokenTurnIds.has(turnId)}`);

				if (dist < THRESHOLD && !window.r2uSpokenTurnIds.has(turnId)) {
					// ğŸ‘‚ í•œ ë²ˆë§Œ ì½ë„ë¡ ê¸°ë¡
					window.r2uSpokenTurnIds.add(turnId);

					const msg = t.instruction || "";
					if (!msg) continue;
					
					console.log(`[TTS SPEAK] Speaking turn instruction for turn ${i}: ${msg}`); // TTS í˜¸ì¶œ ë¡œê·¸

					// ê¸°ì¡´ window.R2UTTS ìš°ì„ 
					if (window.R2UTTS && window.R2UTTS.postMessage) {
						window.R2UTTS.postMessage(msg);
					}
					// â­ ì¶”ê°€: R2UTTS ì „ì—­ ê°ì²´ë¡œë„ ì§€ì›
					else if (typeof R2UTTS !== "undefined" && R2UTTS.postMessage) {
						R2UTTS.postMessage(msg);
					}
				}
			}
		}
	</script>
</body>
</html>
