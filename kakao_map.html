<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
    }
    #map { width:100%; height:100vh; }

    /* ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ */
    .runner-wrapper {
      position: absolute;
      transform: translate(-50%, -50%);  /* ì¤‘ì‹¬ì´ ì¢Œí‘œì— ë”± ì˜¤ë„ë¡ */
      pointer-events:none;
    }

    .user-dir-marker-outer {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.28);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: transform 0.18s linear;
      will-change: transform;
    }

    .user-dir-marker-core {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #1E88E5;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      position: relative;
    }

    .user-dir-marker-arrow {
      position: absolute;
      top: -14px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 12px solid white;
    }

    /* ì½”ìŠ¤ ìœ„ ë°©í–¥ í™”ì‚´í‘œ (ì¶œë°œ/í„´ ì§€ì ìš©) */
    .route-arrow {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 16px solid #00FA73; /* ê¸°ë³¸: í˜•ê´‘ì´ˆë¡ */
      filter: drop-shadow(0 0 3px rgba(0,0,0,0.8));
    }
  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ========= ì „ì—­ ========= */
    let map;

    let routeCoords = [];
    let routeLineBase = null;   // í°ìƒ‰ ë‘êº¼ìš´ ë² ì´ìŠ¤ (ë„¤ë¹„ ëª¨ë“œ)
    let routeLineDone = null;   // ì§€ë‚˜ì˜¨ êµ¬ê°„ (íšŒìƒ‰)
    let routeLineRemain = null; // ë‚¨ì€ êµ¬ê°„ (ì´ˆë¡/íŒŒë‘)

    let startMarker = null;
    let endMarker = null;

    let runnerOverlay = null;
    let runnerWrapperDiv = null;

    let isNavigationMode = false;
    let defaultMapLevel = 3;

    let routeArrows = []; // ë°©í–¥ í™”ì‚´í‘œë“¤
    let routeTurns = [];  // â­ í„´ ìœ„ì¹˜ ì •ë³´ (ì¢Œ/ìš°íšŒì „ ì§€ì )

    /* ========= ì§€ë„ ì´ˆê¸°í™” ========= */
    function initMap() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      });
      defaultMapLevel = map.getLevel();
      console.log("ğŸ—º ì§€ë„ ì´ˆê¸°í™”ë¨");
    }
    initMap();

    /* ========= ë°©í–¥ í™”ì‚´í‘œ ========= */
    function createRouteArrows(coords) {
      // ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }
      if (!coords || coords.length < 2) return;

      
      // 2ï¸âƒ£ í„´ ì§€ì  í™”ì‚´í‘œ (ì¢Œ/ìš°íšŒì „ ì§€ì ì—ë§Œ)
      if (routeTurns && routeTurns.length) {
        routeTurns.forEach(turn => {
          const tLat = turn.lat
          const tLng = turn.lng;
          if (typeof tLat !== 'number' || typeof tLng !== 'number') return;

          const pos = new kakao.maps.LatLng(tLat, tLng);

          // ì´ í„´ ìœ„ì¹˜ì™€ ê°€ì¥ ê°€ê¹Œìš´ polyline segment ì°¾ê¸°
          let nearestIdx = 0;
          let minDist = Infinity;
          for (let i = 0; i < coords.length; i++) {
            const d = kakao.maps.geometry.spherical.computeDistanceBetween(
              pos,
              coords[i]
            );
            if (d < minDist) {
              minDist = d;
              nearestIdx = i;
            }
          }

          const baseIdx = Math.min(nearestIdx, coords.length - 2);
          const segP1 = coords[baseIdx];
          const segP2 = coords[baseIdx + 1];

          const dx = segP2.getLng() - segP1.getLng();
          const dy = segP2.getLat() - segP1.getLat();
          const angleRad = Math.atan2(dy, dx);
          const angleDeg = angleRad * 180 / Math.PI;
          const rotateDeg = angleDeg - 90;

          // íƒ€ì…ë³„ ìƒ‰ìƒ (ì¢Œ/ìš°íšŒì „ êµ¬ë¶„ìš©)
          let color = '#FFFFFF';
          if (turn.type === 'left') {
            color = '#FF7043';   // ì¢ŒíšŒì „: ì£¼í™©
          } else if (turn.type === 'right') {
            color = '#42A5F5';   // ìš°íšŒì „: íŒŒë‘
          } else {
            color = '#FFFFFF';   // ì§ì§„/ê¸°íƒ€
          }

          const html =
            `<div class="route-arrow" style="
                transform: rotate(${rotateDeg}deg);
                transform-origin: 50% 50%;
                border-bottom-color: ${color};
              "></div>`;

          const overlay = new kakao.maps.CustomOverlay({
            position: pos,
            content: html,
            zIndex: 5
          });
          overlay.setMap(map);
          routeArrows.push(overlay);
        });
      }
    }

    /* ========= ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ on/off ========= */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;

      if (isNavigationMode) {
        // ì¶œë°œì ìª½ í™•ëŒ€
        if (map && routeCoords.length > 0) {
          const startPos = routeCoords[0];
          map.setLevel(2);       // í™•ëŒ€
          map.panTo(startPos);   // ì¶œë°œì  ê¸°ì¤€
        } else if (map) {
          map.setLevel(2);
        }

        // í°ìƒ‰ ë² ì´ìŠ¤ ë¼ì¸
        if (routeCoords.length) {
          if (!routeLineBase) {
            routeLineBase = new kakao.maps.Polyline({
              path: routeCoords,
              strokeWeight: 10,
              strokeColor: '#FFFFFF',
              strokeOpacity: 0.9,
              strokeStyle: 'solid',
            });
            routeLineBase.setMap(map);
          }

          // ë‚¨ì€ ê¸¸: ìƒ‰ì€ ê·¸ëŒ€ë¡œ(ì—°ë‘ìƒ‰), ë„¤ë¹„ ì¤‘ì—” ì‚´ì§ ë” ë‘ê»ê²Œë§Œ
          if (routeLineRemain) {
            routeLineRemain.setOptions({
              strokeWeight: 8,   // ğŸ” ë„¤ë¹„ ëª¨ë“œì¼ ë•Œë§Œ ì¡°ê¸ˆ ë” ë‘ê»ê²Œ
            });
          }

          // ë°©í–¥ í™”ì‚´í‘œ ìƒì„± (ì¶œë°œ + í„´ ì§€ì ë§Œ)
          createRouteArrows(routeCoords);
        }
      }
      else {
        // ë„¤ë¹„ ì¢…ë£Œ â†’ ì´ˆë¡ ë¼ì¸ìœ¼ë¡œ ë³µê·€
        if (routeLineRemain) {
          routeLineRemain.setOptions({
            strokeColor: '#00C853',
            strokeWeight: 6,
          });
        }

        if (map) {
          map.setLevel(defaultMapLevel);
        }

        // ëŸ¬ë„ˆ/ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬
        hideRunnerOnRoute();
      }
    };

    /* ========= ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸° ========= */
    window.showRecommendedRoute = function(data) {
      if (!data || !Array.isArray(data.polyline)) {
        console.log("âŒ showRecommendedRoute: polyline ì—†ìŒ");
        return;
      }

      // ìƒˆ ì¢Œí‘œ ì…‹íŒ…
      routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));

      // â­ í„´ ì •ë³´ ì €ì¥ (ì¢Œ/ìš°íšŒì „ ì§€ì )
      routeTurns = [];
      if (Array.isArray(data.turns)) {
        data.turns.forEach(t => {
          // 1) lat/lngê°€ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          if (typeof t.lat === 'number' && typeof t.lng === 'number') {
            routeTurns.push({
              lat: t.lat,
              lng: t.lng,
              type: t.type || 'straight',
              atDistM: t.atDistM || null,
            });
          }
          // 2) lat/lngê°€ ì—†ê³  atDistMë§Œ ìˆìœ¼ë©´, polyline ìœ„ì—ì„œ ìœ„ì¹˜ ê³„ì‚°
          else if (typeof t.atDistM === 'number') {
            const target = t.atDistM;
            let acc = 0;
            for (let i = 0; i < routeCoords.length - 1; i++) {
              const segLen = kakao.maps.geometry.spherical.computeDistanceBetween(
                routeCoords[i],
                routeCoords[i + 1]
              );
              if (acc + segLen >= target) {
                const ratio = (target - acc) / segLen;
                const lat =
                  routeCoords[i].getLat() +
                  (routeCoords[i + 1].getLat() - routeCoords[i].getLat()) * ratio;
                const lng =
                  routeCoords[i].getLng() +
                  (routeCoords[i + 1].getLng() - routeCoords[i].getLng()) * ratio;
                routeTurns.push({
                  lat: lat,
                  lng: lng,
                  type: t.type || 'straight',
                  atDistM: t.atDistM,
                });
                break;
              }
              acc += segLen;
            }
          }
        });
      }

      // ê¸°ì¡´ ë¼ì¸/ë§ˆì»¤/í™”ì‚´í‘œ ì œê±°
      if (routeLineBase)  { routeLineBase.setMap(null);  routeLineBase = null; }
      if (routeLineDone)  { routeLineDone.setMap(null);  routeLineDone = null; }
      if (routeLineRemain){ routeLineRemain.setMap(null);routeLineRemain = null; }
      if (startMarker)    { startMarker.setMap(null);    startMarker = null; }
      if (endMarker)      { endMarker.setMap(null);      endMarker = null; }

      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // ì¶”ì²œë§Œ ë°›ì€ ìƒíƒœ: ì´ˆë¡ìƒ‰ ë¼ì¸ í•œ ê°œ
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 6,
        strokeColor: '#00FA73',
        strokeOpacity: 0.96,
        strokeStyle: 'solid',
      });
      routeLineRemain.setMap(map);

      // ì¶œë°œ/ë„ì°© ë§ˆì»¤
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0],
      });
      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1],
      });

      // âœ… ì½”ìŠ¤ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì¶•ì†Œ/ì´ë™
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);
    };

    /* ========= ì§€ë‚˜ì˜¨ ê¸¸ / ë‚¨ì€ ê¸¸ ì—…ë°ì´íŠ¸ ========= */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      const cur = new kakao.maps.LatLng(lat, lng);
      let idx = 0;
      let minDist = Infinity;

      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath   = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      if (routeLineDone)   routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 7,
        strokeColor: '#555555',   // âœ… ì§€ë‚˜ì˜¨ ê¸¸: íšŒìƒ‰
        strokeOpacity: 0.96,
        strokeStyle: 'solid',
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 9 : 6,
        strokeColor:'#8BC34A',   // âœ… ì•„ì§ ì•ˆ ê°„ ê¸¸: ì—°ë‘ìƒ‰
        strokeOpacity: 0.96,
        strokeStyle: 'solid',
      });
      routeLineRemain.setMap(map);
    };

    /* ========= ì§€ë„ ìë™ ë”°ë¼ê°€ê¸° ========= */
    window.followUser = function(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);
    };

    /* ========= ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ ========= */
    window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {
      if (!isNavigationMode) return;

      const pos = new kakao.maps.LatLng(lat, lng);

      const color = (onRoute === true || onRoute === "true")
        ? "#1E88E5"
        : "#E53935";

      const h = Number(heading || 0);
      const offsetDeg = 0;

      if (!runnerOverlay) {
        runnerWrapperDiv = document.createElement("div");
        runnerWrapperDiv.className = "runner-wrapper";

        const html = `
          <div class="user-dir-marker-outer" id="runnerOuter">
            <div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
            <div class="user-dir-marker-arrow"></div>
          </div>
        `;
        runnerWrapperDiv.innerHTML = html;

        runnerOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: runnerWrapperDiv,
          zIndex: 5,
        });
        runnerOverlay.setMap(map);
      } else {
        runnerOverlay.setPosition(pos);
      }

      // íšŒì „
      const outer = runnerWrapperDiv.querySelector("#runnerOuter");
      if (outer) {
        outer.style.transform = `rotate(${h + offsetDeg}deg)`;
      }

      // ìƒ‰ìƒ
      const core = runnerWrapperDiv.querySelector("#runnerCore");
      if (core) {
        core.style.background = color;
      }
    };

    /* ========= ëŸ¬ë„ˆ/ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬ ========= */
    window.hideRunnerOnRoute = function() {
      if (runnerOverlay) {
        runnerOverlay.setMap(null);
        runnerOverlay = null;
      }
      runnerWrapperDiv = null;

      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      if (routeLineBase) {
        routeLineBase.setMap(null);
        routeLineBase = null;
      }
      if (routeLineDone) {
        routeLineDone.setMap(null);
        routeLineDone = null;
      }
      if (routeLineRemain) {
        routeLineRemain.setMap(null);
        routeLineRemain = null;
      }
      if (startMarker) {
        startMarker.setMap(null);
        startMarker = null;
      }
      if (endMarker) {
        endMarker.setMap(null);
        endMarker = null;
      }

      routeCoords = [];
      routeTurns = [];
    };
  </script>
</body>
</html>

