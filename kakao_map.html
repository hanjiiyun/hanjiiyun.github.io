<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
    }
    #map { width:100%; height:100vh; }

    /* ==========================================
       ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
       ========================================== */
    .runner-wrapper {
      position: absolute;
      transform: translate3d(0,0,0);
      transition: transform 0.18s linear; /* ğŸ”¥ ìì—°ìŠ¤ëŸ¬ìš´ ì´ë™ */
      will-change: transform;
      pointer-events:none;
    }

    .user-dir-marker-outer {
      width: 34px;      /* ë„¤ì´ë²„ë§µ ëŠë‚Œ í¬ê¸° */
      height: 34px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.28);  /* íŒŒë€ ë²ˆì§ */
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: transform 0.18s linear;     /* íšŒì „ ë¶€ë“œëŸ½ê²Œ */
      will-change: transform;
    }

    .user-dir-marker-core {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      position: relative;
    }

    /* ì‚¼ê°í˜• ì‚´ì§ ìœ„ë¡œ ë„ìš°ê¸° (ìœ„ìª½ì´ ì§„í–‰ë°©í–¥ ê¸°ë³¸) */
    .user-dir-marker-arrow {
      position: absolute;
      top: -14px;  /* ì› ë°–ìœ¼ë¡œ ì™„ì „íˆ ì˜¬ë¦¬ê¸° */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 12px solid white; /* ìœ„ìª½ ë°©í–¥ */
    }

    /* ğŸ†• í´ë¦¬ë¼ì¸ ì§„í–‰ ë°©í–¥ í™”ì‚´í‘œ (ì‘ì€ ì‚¼ê°í˜•) */
    .route-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 8px solid #1976D2; /* ë„¤ë¹„ íŒŒë€ìƒ‰ */
    }

  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ==========================================
       ì „ì—­ ë³€ìˆ˜
    ========================================== */
    let map;

    let routeCoords = [];
    let routeLineDone = null;
    let routeLineRemain = null;

    let startMarker = null;
    let endMarker = null;

    let runnerOverlay = null;    // wrapper + ì•„ì´ì½˜
    let runnerWrapperDiv = null;

    let isNavigationMode = false;

    // ë°©í–¥ í™”ì‚´í‘œ ì˜¤ë²„ë ˆì´ë“¤
    let routeArrows = [];

    // ê¸°ë³¸ ì§€ë„ ë ˆë²¨ ì €ì¥ (ë„¤ë¹„ ëª¨ë“œ ëë‚˜ë©´ ë³µì›)
    let defaultMapLevel = 3;

    /* ==========================================
       ì§€ë„ ì´ˆê¸°í™”
    ========================================== */
    function initMap() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      });
      defaultMapLevel = map.getLevel();
      console.log("ğŸ—º ì§€ë„ ì´ˆê¸°í™”ë¨");
    }
    initMap();

    /* ==========================================
       ğŸ” í´ë¦¬ë¼ì¸ ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
    ========================================== */
    function createRouteArrows(coords) {
      // ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }
      if (!coords || coords.length < 2) return;

      const maxArrows = 25;
      const step = Math.max(1, Math.floor(coords.length / maxArrows));

      for (let i = 0; i < coords.length - 1; i += step) {
        const p1 = coords[i];
        const p2 = coords[i + 1];

        const dx = p2.getLng() - p1.getLng();
        const dy = p2.getLat() - p1.getLat();
        const angleRad = Math.atan2(dy, dx);
        const angleDeg = angleRad * 180 / Math.PI;
        // ğŸ”¥ í™”ì‚´í‘œ ê¸°ë³¸ì´ "ìœ„ìª½"ì´ë¼, ë²¡í„° ê°ë„ì— ë§ì¶”ê¸° ìœ„í•´ ì•½ê°„ ë³´ì •
        const rotateDeg = angleDeg - 90;

        const html =
          `<div class="route-arrow" style="
              transform: rotate(${rotateDeg}deg);
              transform-origin: 50% 50%;
            "></div>`;

        const overlay = new kakao.maps.CustomOverlay({
          position: p1,
          content: html,
          zIndex: 4
        });
        overlay.setMap(map);
        routeArrows.push(overlay);
      }
    }

    /* ==========================================
       ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ
       - ì•ˆë‚´ ì‹œì‘ ì‹œ true
       - ì•ˆë‚´ ì¢…ë£Œ ì‹œ false
    ========================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;

      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
          strokeWeight: isNavigationMode ? 8 : 6   // ğŸ”¥ ë” êµµê²Œ
        });
      }

      if (map) {
        if (isNavigationMode) {
          map.setLevel(2);        // ì‚´ì§ í™•ëŒ€
        } else {
          map.setLevel(defaultMapLevel);
          // ì•ˆë‚´ ì¢…ë£Œë˜ë©´ ëŸ¬ë„ˆ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
          hideRunnerOnRoute();
        }
      }
    };

    /* ==========================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    ========================================== */
    window.showRecommendedRoute = function(data) {
      if (!data || !Array.isArray(data.polyline)) return;

      routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // ë‚¨ì€ ê¸¸ (ê¸°ë³¸ ìƒíƒœì—ì„œë„ ì¡°ê¸ˆ ë” êµµê³  íŠ€ê²Œ)
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 6,             // ğŸ”¥ ê¸°ì¡´ë³´ë‹¤ êµµê²Œ
        strokeColor: '#00C853',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // ì§€ë‚œ ê¸¸ (ì´ˆê¸°: ë¹„ì–´ìˆìŒ)
      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 7,             // ğŸ”¥ ì§€ë‚˜ì˜¨ ê¸¸ë„ êµµê²Œ
        strokeColor: '#555555',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });

      // ì¶œë°œ/ë„ì°©
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0]
      });
      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1]
      });

      // ì „ì²´ ë³´ê¸°
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);

      // ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
      createRouteArrows(routeCoords);
    };

    /* ==========================================
       ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸ ì—…ë°ì´íŠ¸
    ========================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      let idx = 0;
      let minDist = Infinity;
      const cur = new kakao.maps.LatLng(lat, lng);

      // ê°€ì¥ ê°€ê¹Œìš´ ì§€ì  ì°¾ê¸°
      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      // ê¸°ì¡´ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 7,
        strokeColor: '#555555',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 8 : 6,
        strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // í™”ì‚´í‘œëŠ” ì²˜ìŒ ì½”ìŠ¤ ê¸°ì¤€ì´ë¼ ë§¤ë²ˆ ë‹¤ì‹œ ë§Œë“¤ í•„ìš” ì—†ìŒ
    };

    /* ==========================================
       Follow Mode (ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°)
    ========================================== */
    window.followUser = function(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);   // ìì—°ìŠ¤ëŸ½ê²Œ ë”°ë¼ê°
    };

    /* ==========================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸(ë¶€ë“œëŸ¬ìš´ ì´ë™)
       âœ… ì•ˆë‚´ ì‹œì‘ì¼ ë•Œ(isNavigationMode=true)ë§Œ í‘œì‹œ
    ========================================== */
    window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {
      // â›” ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì•„ì´ì½˜ í‘œì‹œ ì•ˆ í•¨
      if (!isNavigationMode) return;

      const pos = new kakao.maps.LatLng(lat, lng);
      const proj = map.getProjection();
      const point = proj.containerPointFromCoords(pos);

      const color = (onRoute === true || onRoute === "true")
        ? "#1E88E5"   // ì½”ìŠ¤ ìœ„
        : "#E53935";  // ì½”ìŠ¤ ì´íƒˆ

      // FlutterCompass heading: 0Â° = ë¶, ì‹œê³„ë°©í–¥
      const h = Number(heading || 0);
      const offsetDeg = 0; // ğŸ”¥ ì •í™•í•œ ë°©í–¥ ìš°ì„  (í•„ìš”í•˜ë©´ ì‚´ì§ë§Œ ì¡°ì •)

      // ìµœì´ˆ ìƒì„±
      if (!runnerOverlay) {
        runnerWrapperDiv = document.createElement("div");
        runnerWrapperDiv.className = "runner-wrapper";

        const html = `
          <div class="user-dir-marker-outer" id="runnerOuter">
            <div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
            <div class="user-dir-marker-arrow"></div>
          </div>
        `;

        runnerWrapperDiv.innerHTML = html;

        runnerOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: runnerWrapperDiv,
          zIndex: 5
        });
        runnerOverlay.setMap(map);
      } else {
        runnerOverlay.setPosition(pos);
      }

      // ë¶€ë“œëŸ¬ìš´ ì´ë™
      runnerWrapperDiv.style.transform =
        `translate3d(${point.x - 17}px, ${point.y - 17}px, 0)`; // ì¤‘ì‹¬ ë§ì¶”ê¸°

      // ë°©í–¥ íšŒì „
      const outer = runnerWrapperDiv.querySelector("#runnerOuter");
      outer.style.transform = `rotate(${h + offsetDeg}deg)`;

      // ìƒ‰ìƒ ë³€ê²½
      const core = runnerWrapperDiv.querySelector("#runnerCore");
      core.style.background = color;
    };


    /* ==========================================
       ëŸ¬ë„ˆ ìˆ¨ê¸°ê¸° + ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬
    ========================================== */
    window.hideRunnerOnRoute = function() {
      // ëŸ¬ë„ˆ ì•„ì´ì½˜ ì œê±°
      if (runnerOverlay) {
        runnerOverlay.setMap(null);
        runnerOverlay = null;
      }
      runnerWrapperDiv = null;

      // ë°©í–¥ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // í´ë¦¬ë¼ì¸ / ì¶œë°œÂ·ë„ì°© ë§ˆì»¤ë„ ê°™ì´ ì œê±° (í•„ìš” ì—†ìœ¼ë©´ ì•„ë˜ ë¸”ë¡ì€ ì§€ì›Œë„ ë¨)
      if (routeLineDone) {
        routeLineDone.setMap(null);
        routeLineDone = null;
      }
      if (routeLineRemain) {
        routeLineRemain.setMap(null);
        routeLineRemain = null;
      }
      if (startMarker) {
        startMarker.setMap(null);
        startMarker = null;
      }
      if (endMarker) {
        endMarker.setMap(null);
        endMarker = null;
      }

      // ê²½ë¡œ ì¢Œí‘œ ì´ˆê¸°í™”
      routeCoords = [];
    };
  </script>
</body>
</html>
