<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0; padding:0; height:100%;
    }
    #map { width:100%; height:100vh; }

    /* â­ ëŸ¬ë„ˆ ì•„ì´ì½˜ (íšŒì „ + ìƒ‰ìƒ ë³€ê²½) */
    .user-dir-marker {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background-color: #00C853;
      border: 3px solid white;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .user-dir-marker-inner {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid white;
      transform: translateY(-1px);
    }
  </style>

  <!-- geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ======================================================
       ì „ì—­ ë³€ìˆ˜
    ====================================================== */
    let map;

    let routeCoords = [];
    let routeLineDone = null;      // ì§€ë‚˜ì˜¨ êµ¬ê°„ (íšŒìƒ‰)
    let routeLineRemain = null;    // ë‚¨ì€ êµ¬ê°„ (ì´ˆë¡/íŒŒë‘)
    let startMarker = null;
    let endMarker = null;

    let userDirectionOverlay = null;
    let lastHeadingDeg = 0;
    let isNavigationMode = false;

    /* ======================================================
       ì§€ë„ ì´ˆê¸°í™”
    ====================================================== */
    (function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      };
      map = new kakao.maps.Map(container, options);
      console.log("ğŸ—º map ì´ˆê¸°í™” ì™„ë£Œ");
    })();

    /* ======================================================
       ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ ë³€ê²½
    ====================================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;
      console.log("ğŸš¦ setNavigationMode:", isNavigationMode);

      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
          strokeWeight: isNavigationMode ? 6 : 5
        });
      }
    };

    /* ======================================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    ====================================================== */
    window.showRecommendedRoute = function(routeData) {
      console.log("ğŸ“¡ showRecommendedRoute:", routeData);

      if (!routeData || !Array.isArray(routeData.polyline)) {
        console.log("âš  polyline ì—†ìŒ");
        return;
      }

      // ì „ì²´ ì¢Œí‘œ ë³€í™˜
      routeCoords = routeData.polyline.map(p => {
        return new kakao.maps.LatLng(Number(p.lat), Number(p.lng));
      });

      // ê¸°ì¡´ ìš”ì†Œ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      // ë‚¨ì€ êµ¬ê°„ (ì´ˆë¡)
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // ì§€ë‚˜ì˜¨ êµ¬ê°„(ì´ˆê¸° ë¹ˆ ê°’)
      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 6,
        strokeColor: '#555555',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });

      // ì‹œì‘/ë„ì°© ë§ˆì»¤
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0]
      });

      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1]
      });

      // ì „ì²´ ê²½ë¡œ ë³´ì´ê²Œ
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(pos => bounds.extend(pos));
      map.setBounds(bounds);
    };

    /* ======================================================
       ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸ ê°±ì‹ 
    ====================================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      const nLat = Number(lat);
      const nLng = Number(lng);
      const current = new kakao.maps.LatLng(nLat, nLng);

      // í´ë¦¬ë¼ì¸ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ index ì°¾ê¸°
      let idx = 0;
      let minDist = Infinity;

      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(
          current, routeCoords[i]
        );
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      // ì§€ë‚˜ì˜¨ êµ¬ê°„ = íšŒìƒ‰
      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#555555',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineDone.setMap(map);

      // ë‚¨ì€ êµ¬ê°„
      const remainColor = isNavigationMode ? '#1976D2' : '#00C853';

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: remainColor,
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);
    };

    /* ======================================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    ====================================================== */
    window.updateRunnerOnRoute = function(lat, lng, headingDeg, onRoute) {
      console.log("ğŸ“¡ updateRunnerOnRoute:", lat, lng, headingDeg, onRoute);

      const nLat = Number(lat);
      const nLng = Number(lng);
      let nHeading = Number(headingDeg);
      if (isNaN(nHeading)) nHeading = 0;

      lastHeadingDeg = nHeading;
      const pos = new kakao.maps.LatLng(nLat, nLng);

      // ìƒ‰ìƒ ê²°ì •
      let bgColor = "#00C853";     // ê¸°ë³¸ ì´ˆë¡
      if (isNavigationMode) {
        if (onRoute === true || onRoute === "true")
          bgColor = "#2196F3";     // ì½”ìŠ¤ ìœ„ = íŒŒë‘
        else
          bgColor = "#E53935";     // ì½”ìŠ¤ ì´íƒˆ = ë¹¨ê°•
      }

      const content =
        `<div class="user-dir-marker"
              style="transform: rotate(${nHeading}deg); background-color:${bgColor};">
           <div class="user-dir-marker-inner"></div>
         </div>`;

      if (!userDirectionOverlay) {
        userDirectionOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: content,
          zIndex: 5
        });
        userDirectionOverlay.setMap(map);
      } else {
        userDirectionOverlay.setPosition(pos);
        userDirectionOverlay.setContent(content);
      }
    };

    /* ======================================================
       ëŸ¬ë„ˆ ìˆ¨ê¸°ê¸°
    ====================================================== */
    window.hideRunnerOnRoute = function() {
      if (userDirectionOverlay) {
        userDirectionOverlay.setMap(null);
        userDirectionOverlay = null;
      }
    };
  </script>
</body>
</html>
