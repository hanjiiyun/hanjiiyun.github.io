<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>R2U Kakao Map</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }

    /* â­ í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜ (íšŒì „ìš© ê¸°ë³¸ ìŠ¤íƒ€ì¼)
       - ì‹¤ì œ ìƒ‰ì€ JSì—ì„œ inline style(background-color)ë¡œ ë°”ê¿”ì¤Œ */
    .user-dir-marker {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background-color: #00C853; /* ê¸°ë³¸ ì´ˆë¡ */
      border: 3px solid white;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .user-dir-marker-inner {
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 10px solid white; /* ì‘ì€ ì‚¼ê°í˜• í™”ì‚´í‘œ */
      transform: translateY(-1px);
    }
  </style>

  <!-- âš  geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ì§€ë‚˜ê°„/ë‚¨ì€ êµ¬ê°„ ê³„ì‚°ìš©) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    // ================================
    // ì „ì—­ ë³€ìˆ˜
    // ================================
    var map;

    // ê²½ë¡œ ê´€ë ¨
    var routeCoords = [];        // ì „ì²´ í´ë¦¬ë¼ì¸ ì¢Œí‘œ
    var routeLineDone = null;    // ì´ë¯¸ ì§€ë‚œ êµ¬ê°„(í•˜ì–€ìƒ‰)
    var routeLineRemain = null;  // ì•„ì§ ë‚¨ì€ êµ¬ê°„(íŒŒë€/ì´ˆë¡ìƒ‰)
    var startMarker = null;
    var endMarker = null;

    // ì‚¬ìš©ì ìœ„ì¹˜
    var userMarker = null;           // ì‹¤ì œ GPS ìœ„ì¹˜(íŒŒë€ í•€)
    var userDirectionOverlay = null; // í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜(íšŒì „ + ìƒ‰)
    var lastHeadingDeg = 0;

    // ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ ì—¬ë¶€ (Flutterì—ì„œ setNavigationModeë¡œ ë³€ê²½)
    var isNavigationMode = false;

    // ================================
    // ì§€ë„ ìƒì„± (ì¦‰ì‹œ ì‹¤í–‰)
    // ================================
    (function initMap() {
      var container = document.getElementById('map');
      var options = {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      };
      map = new kakao.maps.Map(container, options);
      console.log("ğŸ—º map ì´ˆê¸°í™” ì™„ë£Œ");
    })();

    // ================================
    // Flutter â†’ JS : ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ on/off
    // ================================
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;
      console.log("ğŸš¦ setNavigationMode:", isNavigationMode);

      // ë„¤ë¹„ ëª¨ë“œì— ë”°ë¼ ë‚¨ì€ êµ¬ê°„ í´ë¦¬ë¼ì¸ ìƒ‰/ë‘ê»˜ ì‚´ì§ ë³€ê²½
      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNavigationMode ? '#1976D2' : '#00C853', // ë„¤ë¹„ ì¤‘ì—” íŒŒë€ìƒ‰ ëŠë‚Œ
          strokeWeight: isNavigationMode ? 6 : 5
        });
      }
    };

    // ================================
    // Flutter â†’ JS : ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    //   showRecommendedRoute(JSON)
    // ================================
    window.showRecommendedRoute = function(routeData) {
      console.log("ğŸ“¡ showRecommendedRoute í˜¸ì¶œ:", routeData);

      if (!routeData || !Array.isArray(routeData.polyline)) {
        console.log("âš  polyline ë°°ì—´ ì—†ìŒ");
        return;
      }

      // ì „ì²´ ê²½ë¡œ ì¢Œí‘œ ë°°ì—´ë¡œ ë³€í™˜
      routeCoords = routeData.polyline.map(function(p) {
        var lat = Number(p.lat);
        var lng = Number(p.lng);
        return new kakao.maps.LatLng(lat, lng);
      });

      if (!routeCoords || routeCoords.length === 0) {
        console.log("âš  routeCoords ë¹„ì–´ ìˆìŒ");
        return;
      }

      // ê¸°ì¡´ í´ë¦¬ë¼ì¸/ë§ˆì»¤ ì œê±°
      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      // ì²˜ìŒì—ëŠ” "ë‚¨ì€ êµ¬ê°„"ë§Œ ì „ì²´ ê²½ë¡œë¡œ í‘œì‹œ (ì´ˆë¡)
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // ì´ë¯¸ ì§€ë‚œ êµ¬ê°„(í•˜ì–€ìƒ‰)ì€ ë¹„ì›Œë‘”ë‹¤
      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 5,
        strokeColor: '#FFFFFF',
        strokeOpacity: 0.0,
        strokeStyle: 'solid'
      });

      // ì‹œì‘/ë„ì°© ë§ˆì»¤
      var startPos = routeCoords[0];
      var endPos = routeCoords[routeCoords.length - 1];

      startMarker = new kakao.maps.Marker({
        map: map,
        position: startPos
      });

      endMarker = new kakao.maps.Marker({
        map: map,
        position: endPos
      });

      // ê²½ë¡œ ì „ì²´ê°€ ë³´ì´ë„ë¡ bounds ì„¤ì •
      var bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(function(pos) {
        bounds.extend(pos);
      });
      map.setBounds(bounds);

      console.log("âœ… í´ë¦¬ë¼ì¸/ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ");
    };

    // ================================
    // Flutter â†’ JS : í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (íŒŒë€ í•€)
    //   showUserLocation(lat, lng)
    // ================================
    window.showUserLocation = function(lat, lng) {
      console.log("ğŸ“¡ showUserLocation:", lat, lng);

      if (!map) {
        console.log("âŒ map ê°ì²´ ì—†ìŒ");
        return;
      }

      var nLat = Number(lat);
      var nLng = Number(lng);
      if (isNaN(nLat) || isNaN(nLng)) {
        console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨:", lat, lng);
        return;
      }

      var pos = new kakao.maps.LatLng(nLat, nLng);

      if (!userMarker) {
        userMarker = new kakao.maps.Marker({
          map: map,
          position: pos,
          zIndex: 3
        });
        console.log("âœ… userMarker ìƒì„±");
      } else {
        userMarker.setPosition(pos);
        console.log("âœ… userMarker ìœ„ì¹˜ ê°±ì‹ ");
      }

      // ì•„ì§ ì¶”ì²œ ê²½ë¡œ ì—†ìœ¼ë©´ ë‚´ ìœ„ì¹˜ë¥¼ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ
      if (!routeCoords || routeCoords.length === 0) {
        map.setCenter(pos);
      }
    };

    // ================================
    // Flutter â†’ JS : ê²½ë¡œ ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
    //   updateRouteProgress(lat, lng)
    //   - í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ
    //     ì§€ë‚˜ê°„ êµ¬ê°„: í°ìƒ‰
    //     ë‚¨ì€ êµ¬ê°„: íŒŒë€ìƒ‰(ë„¤ë¹„)/ì´ˆë¡(ì¼ë°˜)
    // ================================
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords || routeCoords.length === 0) {
        return;
      }

      var nLat = Number(lat);
      var nLng = Number(lng);
      if (isNaN(nLat) || isNaN(nLng)) {
        console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ (updateRouteProgress):", lat, lng);
        return;
      }

      var current = new kakao.maps.LatLng(nLat, nLng);

      // í˜„ì¬ ìœ„ì¹˜ì™€ ê°€ì¥ ê°€ê¹Œìš´ ê²½ë¡œ ìƒì˜ index ì°¾ê¸°
      var idx = 0;
      var minDist = Number.MAX_VALUE;

      for (var i = 0; i < routeCoords.length; i++) {
        var d = kakao.maps.geometry.spherical.computeDistanceBetween(
          current,
          routeCoords[i]
        );
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      var donePath = routeCoords.slice(0, idx + 1);
      var remainPath = routeCoords.slice(idx);

      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      // ì´ë¯¸ ì§€ë‚œ êµ¬ê°„: í°ìƒ‰
      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#FFFFFF',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineDone.setMap(map);

      // ë‚¨ì€ êµ¬ê°„: íŒŒë€ìƒ‰(ë„¤ë¹„ ëª¨ë“œ) / ì´ˆë¡(ì¼ë°˜)
      var remainColor = isNavigationMode ? '#1976D2' : '#00C853';

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: remainColor,
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);
    };

    // ================================
    // Flutter â†’ JS : í´ë¦¬ë¼ì¸ ìœ„ ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    //   updateRunnerOnRoute(lat, lng, headingDeg, onRoute)
    //
    //   - ë„¤ë¹„ X : í•­ìƒ ì´ˆë¡
    //   - ë„¤ë¹„ O + onRoute = true  â†’ íŒŒë€ìƒ‰
    //   - ë„¤ë¹„ O + onRoute = false â†’ ë¹¨ê°„ìƒ‰
    // ================================
    window.updateRunnerOnRoute = function(lat, lng, headingDeg, onRoute) {
      console.log("ğŸ“¡ updateRunnerOnRoute:", lat, lng, headingDeg, onRoute);

      if (!map) {
        console.log("âŒ map ê°ì²´ ì—†ìŒ (updateRunnerOnRoute)");
        return;
      }

      var nLat = Number(lat);
      var nLng = Number(lng);
      var nHeading = Number(headingDeg);

      if (isNaN(nLat) || isNaN(nLng)) {
        console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨ (runner):", lat, lng);
        return;
      }
      if (isNaN(nHeading)) {
        nHeading = 0;
      }

      lastHeadingDeg = nHeading;
      var pos = new kakao.maps.LatLng(nLat, nLng);

      // ğŸ¨ ë°°ê²½ìƒ‰ ê²°ì •
      var bgColor = '#00C853'; // ê¸°ë³¸ ì´ˆë¡

      if (isNavigationMode) {
        if (onRoute) {
          bgColor = '#2196F3'; // ì½”ìŠ¤ ìœ„: íŒŒë€ìƒ‰
        } else {
          bgColor = '#E53935'; // ì½”ìŠ¤ ì´íƒˆ: ë¹¨ê°„ìƒ‰
        }
      }

      // CSSë¡œ íšŒì „ + ìƒ‰ ì ìš©
      var content =
        '<div class="user-dir-marker" ' +
          'style="transform: rotate(' + nHeading + 'deg); ' +
                 'background-color:' + bgColor + ';">' +
          '<div class="user-dir-marker-inner"></div>' +
        '</div>';

      if (!userDirectionOverlay) {
        userDirectionOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: content,
          zIndex: 5
        });
        userDirectionOverlay.setMap(map);
        console.log("âœ… userDirectionOverlay ìƒì„±");
      } else {
        userDirectionOverlay.setPosition(pos);
        userDirectionOverlay.setContent(content);
        console.log("âœ… userDirectionOverlay ê°±ì‹ ");
      }
    };

    // ================================
    // Flutter â†’ JS : ëŸ¬ë„ˆ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
    //   hideRunnerOnRoute()
    // ================================
    window.hideRunnerOnRoute = function() {
      console.log("ğŸ“¡ hideRunnerOnRoute í˜¸ì¶œë¨");
      if (userDirectionOverlay) {
        userDirectionOverlay.setMap(null);
        userDirectionOverlay = null;
      }
    };
  </script>
</body>
</html>
