<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
    }
    #map { width:100%; height:100vh; }

    /* ==========================================
       ğŸ”µ ëŸ¬ë„ˆ ì•„ì´ì½˜ ì• ë‹ˆë©”ì´ì…˜ (ë¶€ë“œëŸ¬ìš´ ì´ë™)
       ========================================== */
    .runner-wrapper {
      position: absolute;
      /* ì§€ë„ ì¢Œí‘œì˜ ì •í™•í•œ ì¤‘ì‹¬ì— ì˜¤ë„ë¡ */
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .user-dir-marker-outer {
      width: 34px;      /* ë„¤ì´ë²„ë§µ ëŠë‚Œ í¬ê¸° */
      height: 34px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.28);  /* íŒŒë€ ë²ˆì§ */
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      transition: transform 0.18s linear;     /* íšŒì „ ë¶€ë“œëŸ½ê²Œ */
      will-change: transform;
    }

    .user-dir-marker-core {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1E88E5;
      border: 3px solid #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.4);
      position: relative;
    }

    /* ì‚¼ê°í˜• ì‚´ì§ ìœ„ë¡œ ë„ìš°ê¸° (ìœ„ìª½ì´ ì§„í–‰ë°©í–¥) */
    .user-dir-marker-arrow {
      position: absolute;
      top: -14px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-bottom: 12px solid white; /* ìœ„ìª½ ë°©í–¥ */
    }

    /* ğŸŒŸ í´ë¦¬ë¼ì¸ ìœ„ ë°©í–¥ í™”ì‚´í‘œ (í°ìƒ‰) */
    .route-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 8px solid #FFFFFF; /* í°ìƒ‰ í™”ì‚´í‘œ */
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.6)); /* íŒŒë€ê¸¸ ìœ„ì—ì„œë„ ì˜ ë³´ì´ê²Œ */
    }

  </style>

  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ==========================================
       ì „ì—­ ë³€ìˆ˜
    ========================================== */
    let map;

    let routeCoords = [];
    let routeLineBase = null;   // ğŸŒŸ í°ìƒ‰ ë‘êº¼ìš´ ë² ì´ìŠ¤ ë¼ì¸ (ë„¤ë¹„ ëª¨ë“œì—ì„œë§Œ)
    let routeLineDone = null;   // ì§€ë‚˜ì˜¨ êµ¬ê°„ (íšŒìƒ‰)
    let routeLineRemain = null; // ë‚¨ì€ êµ¬ê°„ (ì´ˆë¡/íŒŒë‘)

    let startMarker = null;
    let endMarker = null;

    let runnerOverlay = null;    // wrapper + ì•„ì´ì½˜
    let runnerWrapperDiv = null;

    let isNavigationMode = false;

    // ë°©í–¥ í™”ì‚´í‘œ ì˜¤ë²„ë ˆì´ë“¤
    let routeArrows = [];

    // ê¸°ë³¸ ì§€ë„ ë ˆë²¨ ì €ì¥ (ë„¤ë¹„ ëª¨ë“œ ëë‚˜ë©´ ë³µì›)
    let defaultMapLevel = 3;

    /* ==========================================
       ì§€ë„ ì´ˆê¸°í™”
    ========================================== */
    function initMap() {
      const container = document.getElementById('map');
      map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      });
      defaultMapLevel = map.getLevel();
      console.log("ğŸ—º ì§€ë„ ì´ˆê¸°í™”ë¨");
    }
    initMap();

    /* ==========================================
       ğŸ” í´ë¦¬ë¼ì¸ ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
       (ë„¤ë¹„ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©)
    ========================================== */
    function createRouteArrows(coords) {
      // ê¸°ì¡´ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }
      if (!coords || coords.length < 2) return;

      const maxArrows = 25;
      const step = Math.max(1, Math.floor(coords.length / maxArrows));

      for (let i = 0; i < coords.length - 1; i += step) {
        const p1 = coords[i];
        const p2 = coords[i + 1];

        const dx = p2.getLng() - p1.getLng();
        const dy = p2.getLat() - p1.getLat();
        const angleRad = Math.atan2(dy, dx);
        const angleDeg = angleRad * 180 / Math.PI;
        // í™”ì‚´í‘œ ê¸°ë³¸ì´ "ìœ„ìª½"ì´ë¼ ë³´ì •
        const rotateDeg = angleDeg - 90;

        const html =
          `<div class="route-arrow" style="
              transform: rotate(${rotateDeg}deg);
              transform-origin: 50% 50%;
            "></div>`;

        const overlay = new kakao.maps.CustomOverlay({
          position: p1,
          content: html,
          zIndex: 4
        });
        overlay.setMap(map);
        routeArrows.push(overlay);
      }
    }

    /* ==========================================
       ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ
       - ì•ˆë‚´ ì‹œì‘ ì‹œ true
       - ì•ˆë‚´ ì¢…ë£Œ ì‹œ false
    ========================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;

      if (isNavigationMode) {
        // âœ… ì•ˆë‚´ ì‹œì‘: ì‹œì‘ì  ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€/ì´ë™
        if (map) {
          if (routeCoords && routeCoords.length > 0) {
            const startPos = routeCoords[0];
            map.setLevel(2);       // ì‚´ì§ í™•ëŒ€
            map.panTo(startPos);   // ì‹œì‘ì  ìª½ìœ¼ë¡œ ì´ë™
          } else {
            map.setLevel(2);
          }
        }

        // âœ… ë„¤ë¹„ ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼ (í°ìƒ‰ ë² ì´ìŠ¤ + íŒŒë€ ë‚¨ì€ ê¸¸ + ë°©í–¥ í™”ì‚´í‘œ)
        if (routeCoords.length && routeLineRemain) {
          // í°ìƒ‰ ë‘êº¼ìš´ ë² ì´ìŠ¤ ë¼ì¸ ì—†ìœ¼ë©´ ìƒì„±
          if (!routeLineBase) {
            routeLineBase = new kakao.maps.Polyline({
              path: routeCoords,
              strokeWeight: 10,
              strokeColor: '#FFFFFF',
              strokeOpacity: 0.9,
              strokeStyle: 'solid'
            });
            routeLineBase.setMap(map);
          }

          // ë‚¨ì€ ê¸¸ íŒŒë€ìƒ‰/êµµê¸° ë³€ê²½
          routeLineRemain.setOptions({
            strokeColor: '#1976D2',
            strokeWeight: 8
          });

          // ë°©í–¥ í™”ì‚´í‘œ ìƒì„±
          createRouteArrows(routeCoords);
        }
      } else {
        // ë„¤ë¹„ ëª¨ë“œ í•´ì œ
        if (routeLineRemain) {
          // (ì›ë˜ ì´ˆë¡ìƒ‰ ë¼ì¸ìœ¼ë¡œ ë³µì›í•˜ë ¤ë©´ ì—¬ê¸°ì„œ ìƒ‰/êµµê¸° ì¡°ì • ê°€ëŠ¥)
          routeLineRemain.setOptions({
            strokeColor: '#00C853',
            strokeWeight: 6
          });
        }

        if (map) {
          map.setLevel(defaultMapLevel);
          // ì•ˆë‚´ ì¢…ë£Œë˜ë©´ ëŸ¬ë„ˆ + ê²½ë¡œ ì •ë¦¬
          hideRunnerOnRoute();
        }
      }
    };

    /* ==========================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
       âœ… ì¶”ì²œë§Œ ë°›ì€ ìƒíƒœì—ì„œëŠ” ì´ˆë¡ ì„ ë§Œ
    ========================================== */
    window.showRecommendedRoute = function(data) {
      if (!data || !Array.isArray(data.polyline)) return;

      routeCoords = data.polyline.map(p => new kakao.maps.LatLng(p.lat, p.lng));

      // ê¸°ì¡´ ë¼ì¸/ë§ˆì»¤/í™”ì‚´í‘œ ì œê±°
      if (routeLineBase)  { routeLineBase.setMap(null);  routeLineBase  = null; }
      if (routeLineDone)  { routeLineDone.setMap(null);  routeLineDone  = null; }
      if (routeLineRemain){ routeLineRemain.setMap(null);routeLineRemain= null; }
      if (startMarker)    { startMarker.setMap(null);    startMarker    = null; }
      if (endMarker)      { endMarker.setMap(null);      endMarker      = null; }

      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // âœ… ì¶”ì²œë§Œ ë°›ì€ ìƒíƒœ: ì´ˆë¡ìƒ‰ í´ë¦¬ë¼ì¸ë§Œ í‘œì‹œ
      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 6,
        strokeColor: '#00C853',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // ì§€ë‚œ ê¸¸ì€ ë„¤ë¹„ ëª¨ë“œì—ì„œë§Œ ì“°ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„  ë¹„ì›Œë‘ 
      routeLineDone = null;

      // ì¶œë°œ/ë„ì°© ë§ˆì»¤
      startMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[0]
      });
      endMarker = new kakao.maps.Marker({
        map: map,
        position: routeCoords[routeCoords.length - 1]
      });

      // ì „ì²´ ë³´ê¸°
      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);
    };

    /* ==========================================
       ì§€ë‚˜ì˜¨ ê¸¸/ë‚¨ì€ ê¸¸ ì—…ë°ì´íŠ¸
    ========================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      let idx = 0;
      let minDist = Infinity;
      const cur = new kakao.maps.LatLng(lat, lng);

      // ê°€ì¥ ê°€ê¹Œìš´ ì§€ì  ì°¾ê¸°
      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(cur, routeCoords[i]);
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath   = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      // ê¸°ì¡´ done/remain ì œê±° (baseëŠ” ê·¸ëŒ€ë¡œ)
      if (routeLineDone)   routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 7,
        strokeColor: '#555555',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineDone.setMap(map);

      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 8 : 6,
        strokeColor: isNavigationMode ? '#1976D2' : '#00C853',
        strokeOpacity: 0.96,
        strokeStyle: 'solid'
      });
      routeLineRemain.setMap(map);

      // í™”ì‚´í‘œëŠ” ì „ì²´ ì½”ìŠ¤ ê¸°ì¤€ì´ë¼ ì¬ìƒì„± í•„ìš” ì—†ìŒ (ë„¤ë¹„ ëª¨ë“œì—ì„œë§Œ ìœ ì§€)
    };

    /* ==========================================
       Follow Mode (ì§€ë„ ìë™ ë”°ë¼ê°€ê¸°)
    ========================================== */
    window.followUser = function(lat, lng) {
      const pos = new kakao.maps.LatLng(lat, lng);
      map.panTo(pos);
    };

    /* ==========================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸(ë¶€ë“œëŸ¬ìš´ ì´ë™)
       âœ… ë„¤ë¹„ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ
       âœ… CustomOverlay ì¢Œí‘œì— ë§ê²Œ ì¤‘ì‹¬ ì •ë ¬
    ========================================== */
    window.updateRunnerOnRoute = function(lat, lng, heading, onRoute) {
      // ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì•„ì´ì½˜ í‘œì‹œ ì•ˆ í•¨
      if (!isNavigationMode) return;

      const pos  = new kakao.maps.LatLng(lat, lng);

      const color = (onRoute === true || onRoute === "true")
        ? "#1E88E5"   // ì½”ìŠ¤ ìœ„
        : "#E53935";  // ì½”ìŠ¤ ì´íƒˆ

      const h = Number(heading || 0);
      const offsetDeg = 0; // í•„ìš”í•˜ë©´ ì•½ê°„ ë³´ì •

      // ìµœì´ˆ ìƒì„±
      if (!runnerOverlay) {
        runnerWrapperDiv = document.createElement("div");
        runnerWrapperDiv.className = "runner-wrapper";

        const html = `
          <div class="user-dir-marker-outer" id="runnerOuter">
            <div class="user-dir-marker-core" id="runnerCore" style="background:${color};"></div>
            <div class="user-dir-marker-arrow"></div>
          </div>
        `;

        runnerWrapperDiv.innerHTML = html;

        runnerOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: runnerWrapperDiv,
          zIndex: 5
        });
        runnerOverlay.setMap(map);
      } else {
        runnerOverlay.setPosition(pos);
      }

      // âœ… ìœ„ì¹˜ëŠ” CustomOverlayê°€ ì•Œì•„ì„œ ë§ì¶”ê³ , ìš°ë¦¬ëŠ” íšŒì „/ìƒ‰ë§Œ ì¡°ì •
      const outer = runnerWrapperDiv.querySelector("#runnerOuter");
      if (outer) {
        outer.style.transform = `rotate(${h + offsetDeg}deg)`;
      }

      const core = runnerWrapperDiv.querySelector("#runnerCore");
      if (core) {
        core.style.background = color;
      }
    };


    /* ==========================================
       ëŸ¬ë„ˆ/ê²½ë¡œ/í™”ì‚´í‘œ ì •ë¦¬
    ========================================== */
    window.hideRunnerOnRoute = function() {
      // ëŸ¬ë„ˆ ì•„ì´ì½˜ ì œê±°
      if (runnerOverlay) {
        runnerOverlay.setMap(null);
        runnerOverlay = null;
      }
      runnerWrapperDiv = null;

      // ë°©í–¥ í™”ì‚´í‘œ ì œê±°
      if (routeArrows.length) {
        routeArrows.forEach(a => a.setMap(null));
        routeArrows = [];
      }

      // í´ë¦¬ë¼ì¸ / ì¶œë°œÂ·ë„ì°© ë§ˆì»¤ë„ ê°™ì´ ì œê±°
      if (routeLineBase) {
        routeLineBase.setMap(null);
        routeLineBase = null;
      }
      if (routeLineDone) {
        routeLineDone.setMap(null);
        routeLineDone = null;
      }
      if (routeLineRemain) {
        routeLineRemain.setMap(null);
        routeLineRemain = null;
      }
      if (startMarker) {
        startMarker.setMap(null);
        startMarker = null;
      }
      if (endMarker) {
        endMarker.setMap(null);
        endMarker = null;
      }

      // ê²½ë¡œ ì¢Œí‘œ ì´ˆê¸°í™”
      routeCoords = [];
    };
  </script>
</body>
</html>
