<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>R2U Kakao Map</title>

  <style>
    html, body {
      margin:0; padding:0; height:100%;
    }
    #map { width:100%; height:100vh; }

    /* ---------------------------------------------------
       ğŸ“ ë„¤ì´ë²„ë§µ ìŠ¤íƒ€ì¼ì˜ í˜„ì¬ ìœ„ì¹˜ ì•„ì´ì½˜
       - ì‘ì€ íŒŒë€ ì› (ì•½ 14~15px)
       - ë°”ê¹¥ Halo ì•½ 30px
       - ì‚¼ê°í˜•ì€ ì› ë°–ìœ¼ë¡œ ì‚´ì§ ëŒì¶œ
    --------------------------------------------------- */

    /* ë°”ê¹¥ Halo */
    .user-dir-marker-outer {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(33, 150, 243, 0.18); 
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* íŒŒë€ Core ì› (ë„¤ì´ë²„ë§µ ì‚¬ì´ì¦ˆ ëŠë‚Œ) */
    .user-dir-marker-core {
      position: relative;
      width: 14px;     /* ğŸŒŸ ë„¤ì´ë²„ë§µ í¬ê¸° */
      height: 14px;
      border-radius: 50%;
      background: #1E88E5; /* ê¸°ë³¸ íŒŒë€ìƒ‰ */
      border: 2px solid #fff;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }

    /* ì‚¼ê°í˜• íšŒì „ìš© ë˜í¼ */
    .user-dir-marker-arrow-wrap {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-start;   /* ì› ìœ„ìª½ì— ì‚¼ê°í˜• ë¶™ì´ê¸° */
      justify-content: center;
      transform-origin: center center;
    }

    /* ì‚¼ê°í˜• (ì› ë°–ìœ¼ë¡œ íŠ€ì–´ë‚˜ì˜´) */
    .user-dir-marker-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 10px solid #ffffff;
      transform: translateY(-10px); /* ğŸŒŸ ì› ìœ„ë¡œ ë” íŠ€ì–´ë‚˜ì˜¤ê²Œ */
    }
  </style>

  <!-- geometry í¬í•¨ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf&libraries=geometry"></script>
</head>

<body>
  <div id="map"></div>

  <script>
    /* ===========================================================
       ì „ì—­ ë³€ìˆ˜
    =========================================================== */
    let map;

    let routeCoords = [];
    let routeLineDone = null;
    let routeLineRemain = null;
    let startMarker = null;
    let endMarker = null;

    let userDirectionOverlay = null;
    let lastHeadingDeg = 0;
    let isNavigationMode = false;

    /* ===========================================================
       ì§€ë„ ì´ˆê¸°í™”
    =========================================================== */
    (function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.4507, 126.6530),
        level: 3
      };
      map = new kakao.maps.Map(container, options);
      console.log("ğŸ—º map ì´ˆê¸°í™” ì™„ë£Œ");
    })();

    /* ===========================================================
       Follow Mode (ë„¤ë¹„ê²Œì´ì…˜ ëª¨ë“œ)
    =========================================================== */
    window.setNavigationMode = function(isNav) {
      isNavigationMode = !!isNav;

      if (routeLineRemain) {
        routeLineRemain.setOptions({
          strokeColor: isNav ? '#1976D2' : '#00C853',
          strokeWeight: isNav ? 6 : 5
        });
      }
    };

    /* ===========================================================
       ì¶”ì²œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    =========================================================== */
    window.showRecommendedRoute = function(routeData) {
      if (!routeData || !Array.isArray(routeData.polyline)) return;

      routeCoords = routeData.polyline.map(p =>
        new kakao.maps.LatLng(Number(p.lat), Number(p.lng))
      );

      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      routeLineRemain = new kakao.maps.Polyline({
        path: routeCoords,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9
      });
      routeLineRemain.setMap(map);

      routeLineDone = new kakao.maps.Polyline({
        path: [],
        strokeWeight: 6,
        strokeColor: '#555',
        strokeOpacity: 0.9
      });

      startMarker = new kakao.maps.Marker({
        map,
        position: routeCoords[0]
      });

      endMarker = new kakao.maps.Marker({
        map,
        position: routeCoords[routeCoords.length - 1]
      });

      const bounds = new kakao.maps.LatLngBounds();
      routeCoords.forEach(p => bounds.extend(p));
      map.setBounds(bounds);
    };

    /* ===========================================================
       ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    =========================================================== */
    window.updateRouteProgress = function(lat, lng) {
      if (!routeCoords.length) return;

      const current = new kakao.maps.LatLng(lat, lng);

      // ê°€ì¥ ê°€ê¹Œìš´ index ì°¾ê¸°
      let idx = 0;
      let minDist = Infinity;
      for (let i = 0; i < routeCoords.length; i++) {
        const d = kakao.maps.geometry.spherical.computeDistanceBetween(
          current, routeCoords[i]
        );
        if (d < minDist) {
          minDist = d;
          idx = i;
        }
      }

      const donePath = routeCoords.slice(0, idx + 1);
      const remainPath = routeCoords.slice(idx);

      if (routeLineDone) routeLineDone.setMap(null);
      if (routeLineRemain) routeLineRemain.setMap(null);

      routeLineDone = new kakao.maps.Polyline({
        path: donePath,
        strokeWeight: 6,
        strokeColor: '#555'
      });
      routeLineDone.setMap(map);

      const color = isNavigationMode ? '#1976D2' : '#00C853';
      routeLineRemain = new kakao.maps.Polyline({
        path: remainPath,
        strokeWeight: isNavigationMode ? 6 : 5,
        strokeColor: color
      });
      routeLineRemain.setMap(map);
    };

    /* ===========================================================
       ëŸ¬ë„ˆ ì•„ì´ì½˜ (ë„¤ì´ë²„ ìŠ¤íƒ€ì¼) ì—…ë°ì´íŠ¸
       + Follow Mode : ì§€ë„ ì¤‘ì‹¬ì„ í•­ìƒ posë¡œ ì´ë™
    =========================================================== */
    window.updateRunnerOnRoute = function(lat, lng, headingDeg, onRoute) {
      const pos = new kakao.maps.LatLng(lat, lng);

      // Follow Mode - ì§€ë„ ì¤‘ì‹¬ ì´ë™
      map.setCenter(pos);

      // ìƒ‰ìƒ
      let coreColor = "#1E88E5";
      if (isNavigationMode) {
        if (onRoute === "false" || onRoute === false) {
          coreColor = "#E53935";
        }
      }

      const content = `
      <div class="user-dir-marker-outer" style="transform: rotate(${headingDeg}deg);">
        <div class="user-dir-marker-core" style="background:${coreColor};">
          <div class="user-dir-marker-arrow-wrap">
            <div class="user-dir-marker-arrow"></div>
          </div>
        </div>
      </div>
      `;

      if (!userDirectionOverlay) {
        userDirectionOverlay = new kakao.maps.CustomOverlay({
          position: pos,
          content: content,
          zIndex: 5
        });
        userDirectionOverlay.setMap(map);
      } else {
        userDirectionOverlay.setPosition(pos);
        userDirectionOverlay.setContent(content);
      }
    };

    /* ìˆ¨ê¸°ê¸° */
    window.hideRunnerOnRoute = function() {
      if (userDirectionOverlay) {
        userDirectionOverlay.setMap(null);
        userDirectionOverlay = null;
      }
    };
  </script>
</body>
</html>
