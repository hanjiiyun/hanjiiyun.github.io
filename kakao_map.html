<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
  />
  <title>R2U Kakao Map</title>
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100vh; }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f3beaea643bdd2136019b366df1190cf"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    // ğŸ”¹ ì „ì—­ ë³€ìˆ˜
    var map;
    var routeLine = null;
    var startMarker = null;
    var endMarker = null;
    var userMarker = null;   // ë‚´ ìœ„ì¹˜ ë§ˆì»¤

    // ğŸ”¹ ì§€ë„ ìƒì„±
    (function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.4507, 126.6530), // ì¸í•˜ëŒ€ ê·¼ì²˜
        level: 3
      };
      map = new kakao.maps.Map(container, options);
      console.log("ğŸ—º map ì´ˆê¸°í™” ì™„ë£Œ");
    })();

    // ------------------------------------------------
    // ğŸ”¹ Flutterì—ì„œ í˜¸ì¶œ: ì¶”ì²œ ê²½ë¡œ í‘œì‹œ (ì „ì—­ì— ë…¸ì¶œ)
    // ------------------------------------------------
    window.showRecommendedRoute = function(routeData) {
      console.log("ğŸ“¡ showRecommendedRoute í˜¸ì¶œë¨, ë°›ì€ ë°ì´í„°:", routeData);

      if (!routeData || !Array.isArray(routeData.polyline)) {
        console.log("âš  polyline ë°°ì—´ì´ ì—†ìŠµë‹ˆë‹¤. keys:", Object.keys(routeData || {}));
        return;
      }

      console.log("ğŸ“ polyline ê¸¸ì´:", routeData.polyline.length);

      var linePath = routeData.polyline.map(function(p) {
        var lat = Number(p.lat);
        var lng = Number(p.lng);
        return new kakao.maps.LatLng(lat, lng);
      });

      if (linePath.length === 0) {
        console.log("âš  linePathê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      // ê¸°ì¡´ ê²½ë¡œ/ë§ˆì»¤ ì œê±°
      if (routeLine) {
        routeLine.setMap(null);
      }
      if (startMarker) startMarker.setMap(null);
      if (endMarker) endMarker.setMap(null);

      // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
      routeLine = new kakao.maps.Polyline({
        map: map,
        path: linePath,
        strokeWeight: 5,
        strokeColor: '#00C853',
        strokeOpacity: 0.9,
        strokeStyle: 'solid'
      });

      // ì‹œì‘/ë ë§ˆì»¤
      var startPos = linePath[0];
      var endPos = linePath[linePath.length - 1];

      startMarker = new kakao.maps.Marker({
        map: map,
        position: startPos
      });

      endMarker = new kakao.maps.Marker({
        map: map,
        position: endPos
      });

      // ì „ì²´ ê²½ë¡œ ë³´ì´ë„ë¡ bounds ë§ì¶”ê¸°
      var bounds = new kakao.maps.LatLngBounds();
      linePath.forEach(function (pos) {
        bounds.extend(pos);
      });
      map.setBounds(bounds);

      console.log("âœ… í´ë¦¬ë¼ì¸/ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ");
    };

    // ------------------------------------------------
    // ğŸ”µ Flutterì—ì„œ í˜¸ì¶œ: ì‚¬ìš©ì í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ (ì „ì—­ì— ë…¸ì¶œ)
    // ------------------------------------------------
    window.showUserLocation = function(lat, lng) {
      console.log("ğŸ“¡ showUserLocation í˜¸ì¶œë¨:", lat, lng);

      if (!map) {
        console.log("âŒ map ê°ì²´ ì—†ìŒ");
        return;
      }

      // lat/lngê°€ ìˆ«ìì¸ì§€ í•œ ë²ˆ ì°ì–´ë³´ê¸°
      var nLat = Number(lat);
      var nLng = Number(lng);
      if (isNaN(nLat) || isNaN(nLng)) {
        console.log("âŒ lat/lng ìˆ«ì ë³€í™˜ ì‹¤íŒ¨:", lat, lng);
        return;
      }

      var pos = new kakao.maps.LatLng(nLat, nLng);

      // ì²˜ìŒ í•œ ë²ˆë§Œ ë§ˆì»¤ ìƒì„±
      if (!userMarker) {
        userMarker = new kakao.maps.Marker({
          map: map,
          position: pos,
          zIndex: 3
        });
        console.log("âœ… userMarker ìƒì„±");
      } else {
        userMarker.setPosition(pos);
        console.log("âœ… userMarker ìœ„ì¹˜ ê°±ì‹ ");
      }

      // ì§€ë„ ì¤‘ì•™ ì´ë™
      map.setCenter(pos);
    };
  </script>
</body>
</html>
